---
title: "Distinguishing latitudinal changes of shallow reef species over a decade of environmental change in Australia"
author: "Yann Herrera Fuchs"
date: "2023-01-25"
output: 
  html_document:
    theme: darkly
    highlight: default
    toc: true
    toc_depth: 3
    toc_float:
      toc_collapse: true
    code_folding: hide
    fig_width: 10
    fig_height: 7
    fig_caption: true
---

This is the code used for analyzing the data for Chapter 1

Remember to set working directory

# Load initial packages and data {.tabset}

*Packages used* 
```{r Load packages, message=FALSE, warning=FALSE}
rm(list = ls()) # clear environment memory

dir <- "C:/Users/yherrera/OneDrive - University of Tasmania/Desktop/UTas/R/chapter1"
setwd(dir)

# Data wrangling
library(tidyverse) # for manipulating data in tidy format
library(data.table) # summarizing and subsetting more efficiently using data.table syntax
library(DT) # for online data.table manipulation

# Statistical analysis

# Maps and figures

```

*Input data*
```{r Reading raw data, message=FALSE}
# RLS dataset
rls.raw <- fread("../Raw Data/ep_m1_m2_AUS.csv") #nrows = 1,634,614

# Species traits dataset (for extracting guild information)
traits <- fread("../Raw Data/TRAITS MASTER.csv") #nrows = 5,188

# RLS survey ID sea-surface temperature dataset (Conor's method)
sst_data <- fread("../Raw Data/rls_sites_sst2.csv") #nrows = 54,973
```

***
## Code
### Organizing data

Adjust species naming conventions
```{r}
rls.raw[, taxon:= ifelse(taxon == "Cenolia glebosus",
                         "Tropiometra afra",
                         ifelse(taxon == "Echinostrephus molaris",
                                "Echinostrephus aciculatus",
                                ifelse(taxon == "Fistularia pertimba", "Fistularia commersonii",
                                       ifelse(taxon == "Holothuria nobilis",
                                              "Holothuria whitmaei",
                                              ifelse(taxon == "Saurida nebulosa", "Saurida gacilis",
                                                     taxon)))))]
```


Add guild information from the traits matrix.
```{r}
# Join datasets
rls <- rls.raw[traits[, .(taxon = `CURRENT_SPECIES_NAME`,
                          guild = `thermal guild`)], 
               on= "taxon", nomatch = NULL] # nrow = 1,575,443
```

Add information on SST at each survey. We are using the average of the 2-years daily SST leading to the survey date. This is to account for periods of extreme or anomalous weather events.
```{r}
# Get mean SST at each survey ID
sst_data <- sst_data[, .(mean_sst = mean(mean_sst, na.rm = TRUE)), by = .(survey_id)] # nrow = 28,074

# Select columns of interest from SST data
rls <- rls[sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL]#nrow = 1,575,691

rls <- rls[!is.na(mean_sst)] #nrow = 1,272,381
```

***

### Filtering and processing the data 
#### Removing unnecessary data

Remove data that will not be used in this analysis.
```{r Remove unnecessary data, message=FALSE, warning=FALSE}
# Remove species with .sp and .spp (those which don't have species fully resolved)
rls <- rls[which(grepl("sp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,271,259
rls <- rls[which(grepl("spp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,249,991

# Remove NAs in taxon data
rls <- rls[which(is.na(rls$taxon) == F), ] #nrow = 1,249,991

# Select vertebrate and invertebrate classes to include in analysis
rls <- rls[class %in% c("Asteroidea", "Cephalopoda", "Crinoidea", "Echinoidea", "Gastropoda", "Holothuroidea", "Malacostraca", "Actinopterygii", "Elasmobranchii"), ] #nrow = 1,243,199 
#NOTE: changed Chondrichtyes to Elasmobranchii, Crinoidea and Holothuroidea not found in raw dataset

# Subset to data from 2010 onwards
rls <- rls[year(survey_date) >= "2010"] #nrow = 1,105,661
```

#### Data adjustments
Make sure that there is a unique latitude and longitude value for each site_code.

```{r}
# Calculate mean latitude and longitude values to obtain unique coordinates
rls_sites <- rls[, lapply(.SD, mean), 
                 by = .(site_code),
                 .SDcols = c("latitude", "longitude")]


rls <- rls[, c(1:8, 11:34)][rls_sites, on= .(site_code)] 
```

Adjust method and block data. There should only be two blocks in each transect, and cryptic fish and invertebrates are only found in method 2.
```{r Adjust method and block, message=FALSE, warning=FALSE}
# Remove block 0
rls <- rls[block != 0] #nrow = 1,105,659

# Remove fish species in M2 from M1 (cryptic fish)
rls[method == 1 & taxon %in% rls[method == 2 & class == "Actinopterygii"]$taxon]$method <- 2
    
# Change method 1 inverts to method 2
rls[class != "Actinopterygii" & class != "Elasmobranchii"]$method <- 2
```

The raw data is already tallied by block, so we need to sum abundance data for each species by survey ID to get N per 500m^2^ for M1, and per 50m^2^ for M2 (the total of each unique species on each survey).
```{r Summing abundance data, message=FALSE, warning=FALSE}
rls <- rls[, .(total = sum(total)), 
           by = .(taxon, survey_id,
                  # add factors of interest
                  class, guild, 
                  site_code, latitude, longitude,
                  survey_date, 
                  mean_sst)] #nrow = 457,244
```

#### Site selection and time periods
In order to avoid sampling biases, we focus on analyzing latitudinal change from the first and last years that sites were surveyed using June 2016 as a heatwave cutoff 

```{r}
# Define period
rls <- rls[, period:= ifelse(survey_date < "2016-06-01", # heatwave period
                             "t1", "t2")]
# Select sites
rls <- rls[, ':=' (year_i = min(year(survey_date)),
                   year_f = max(year(survey_date)),
                   dt = max(year(survey_date)) - min(year(survey_date))),
           by = .(site_code)]

rls[, mean(dt)] # average time period: 6.77 years

# Remove data in between those time periods and those sites that were only surveyed once. Also removed sites that were not found in both periods
rls <- rls[year(survey_date) == year_i | year(survey_date) == year_f] #nrow = 273,508
rls <- rls[dt > 0] #nrow = 205,153
rls <- rls[site_code %in% rls[period == "t1"]$site_code & site_code %in% rls[period == "t2"]$site_code] #nrow = 178,124
```

#### Further filtering

To reduce noise we set taxon-level filters.

```{r}
# Discard species occurring in less than 30 sites.
species_list <- rls[, .(site_code = unique(site_code)), by = .(taxon)][, .(N_site = .N), by = .(taxon)]
rls <- rls[species_list, on= .(taxon)][N_site >= 30] # nrow = 164,603

# Categorize rare and common species based on whether they appear in less than 80 sites in the first time period
rls <- rls[, presence:= ifelse(N_site < 80, "rare", "common"), 
                    by = .(taxon)]
```

We also have to calculate the average abundance of species per site per period, and average temperature data the same way.
```{r Site-specific temperature and abundance data per year, message=TRUE, warning=FALSE}
# Density (abundance per site), temperature and site calculations by year
rls <- rls[, lapply(.SD, mean), # calculate means for the specified data cols
           by = .(taxon, site_code, period,
                  # include factors of interest
                  class, 
                  guild, presence, 
                  latitude, longitude,
                  year_i, year_f, dt,
                  N_site), # subsets
           .SDcols = c("total", "mean_sst")] # data cols to average
# nrow = 101,044
```

### Calculating distribution limits

##### Skew values, 5th and 95th percentiles

To compare parameter values to changes in abundance, we calculate the midway point (skew), 5th and 95th percentiles of cumulative site abundance for each species at each period. Then we extract the latitude associated to these values to assess the change before and after the heatwave.

```{r}
# Set sides
rls <- rls[, side:= ifelse(longitude < 147, "west", "east")]

# Order "rls" dataset from north to south for each species
rls <- rls[order(taxon, -latitude)]
```

###### Northern limits of tropical species
These limits are combined given the geography of tropical Australia
```{r}
## Northern limits tropical species
# Calculate cumulative sum of site abundance by species at each period
rls_trop <- rls[guild == "tropical"]

rls_trop[, ':=' (cum_abun = cumsum(total)),
         by = .(taxon, period)]

# Calculate 5th percentile (N limit)
rls_trop[, ':=' (abun_5 = round(max(cum_abun) * 0.05)), 
         by = .(taxon, period)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_trop <- rls_trop[, .(min_dif = abs(abun_5 - cum_abun), 
                           cum_abun, abun_5, 
                           Lat05 = latitude,
                           Lon05 = longitude,
                           site05 = site_code,
                           Temp05 = mean_sst), 
                       by = .(taxon, period)][order(taxon, period, min_dif)][, .SD[1], by = .(taxon, period)]

# Join to main rls subset
rls_trop <- rls_trop[Lat05_trop[, .(taxon, period, Lat05, Lon05, site05, Temp05)], on= .(taxon, period)]
```

###### Optimum and southern limits of tropical species
```{r}
## Tropical species optimum and southern 
rls_trop[, cum_abun:= cumsum(total),,
         by = .(taxon, period, side)]

# Calculate midway point and 95th percentiles
rls_trop[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                 abun_95 = round(max(cum_abun) * 0.95)), 
         by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_trop <- rls_trop[, .(min_dif = abs(abun_mid - cum_abun), 
                             cum_abun, abun_mid, 
                             Latskew = latitude,
                             Lonskew = longitude,
                             siteskew = site_code,
                             Tempskew = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_trop <- rls_trop[, .(min_dif = abs(abun_95 - cum_abun), 
                           cum_abun, abun_95, 
                           Lat95 = latitude,
                           Lon95 = longitude,
                           site95 = site_code,
                           Temp95 = mean_sst), 
                       by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_trop <- rls_trop[Latskew_trop[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]
rls_trop <- rls_trop[Lat95_trop[, .(taxon, period, side, Lat95, Lon95, site95, Temp95)], on= .(taxon, period, side)]
```

###### Temperate species occuring on only one side
```{r}
## Temperate species
# Species occuring only on one side
# Calculate cumulative sum of site abundance by species at each period and side
# Temperate species have combined east and west lower limits (only if they occur on both sides)
# List temperate species which are found on only one side
temp_1side <- rls[guild == "temperate", .(taxon = unique(taxon)), by = .(side)][, .N, by = .(taxon)][order(N)][N < 2]

rls_temp1 <- rls[taxon %in% temp_1side$taxon]

rls_temp1[, cum_abun:= cumsum(total),
          by = .(taxon, period, side)]

# Calculate midway point, 5th and 95th percentiles
rls_temp1[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                  abun_5 = round(max(cum_abun) * 0.05),
                  abun_95 = round(max(cum_abun) * 0.95)), 
          by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_temp1 <- rls_temp1[, .(min_dif = abs(abun_mid - cum_abun), 
                               cum_abun, abun_mid, 
                               Latskew = latitude,
                               Lonskew = longitude,
                               siteskew = site_code,
                               Tempskew = mean_sst), 
                           by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Latskew_temp1[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_temp1 <- rls_temp1[, .(min_dif = abs(abun_5 - cum_abun), 
                             cum_abun, abun_5, 
                             Lat05 = latitude,
                             Lon05 = longitude,
                             site05 = site_code,
                             Temp05 = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Lat05_temp1[, .(taxon, period, side, Lat05, Lon05, site05, Temp05)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_temp1 <- rls_temp1[, .(min_dif = abs(abun_95 - cum_abun), 
                             cum_abun, abun_95, 
                             Lat95 = latitude,
                             Lon95 = longitude,
                             site95 = site_code,
                             Temp95 = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Lat95_temp1[, .(taxon, period, side, Lat95, Lon95, site95, Temp95)], on= .(taxon, period, side)]
```

###### Temperate species occuring on both sides
```{r}
# Species occuring on both sides
# Calculate cumulative sum of site abundance by species at each period and side
# List temperate species which are found on both sides
temp_2side <- rls[guild == "temperate", .(taxon = unique(taxon)), by = .(side)][, .N, by = .(taxon)][order(N)][N == 2]

rls_temp2_NO <- rls[taxon %in% temp_2side$taxon]

rls_temp2_NO[, cum_abun:= cumsum(total),
          by = .(taxon, period, side)]

# Calculate midway point and 5th percentiles
rls_temp2_NO[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                     abun_5 = round(max(cum_abun) * 0.05)), 
             by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_temp2 <- rls_temp2_NO[, .(min_dif = abs(abun_mid - cum_abun), 
                                  cum_abun, abun_mid, 
                                  Latskew = latitude,
                                  Lonskew = longitude,
                                  siteskew = site_code,
                                  Tempskew = mean_sst), 
                              by = .(taxon, period, side)][order(taxon, period, side,  min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp2 <- rls_temp2_NO[Latskew_temp2[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_temp2 <- rls_temp2_NO[, .(min_dif = abs(abun_5 - cum_abun), 
                                cum_abun, abun_5, 
                                Lat05 = latitude,
                                Lon05 = longitude,
                                site05 = site_code,
                                Temp05 = mean_sst), 
                            by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp2 <- rls_temp2[Lat05_temp2[, .(taxon, period, side, Lat05, Lon05, site05, Temp05)], on= .(taxon, period, side)]

# The southern limits for these species are combined
rls_temp2_S <- rls[taxon %in% temp_2side$taxon]

rls_temp2_S[, cum_abun:= cumsum(total),
            by = .(taxon, period)]

# Calculate midway point, 5th and 95th percentiles
rls_temp2_S[, ':=' (abun_95 = round(max(cum_abun) * 0.95)), 
            by = .(taxon, period)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_temp2 <- rls_temp2_S[, .(min_dif = abs(abun_95 - cum_abun), 
                               cum_abun, abun_95, 
                               Lat95 = latitude,
                               Lon95 = longitude,
                               site95 = site_code,
                               Temp95 = mean_sst), 
                           by = .(taxon, period)][order(taxon, period, min_dif)][, .SD[1], by = .(taxon, period)]

# Join to main rls subset
rls_temp2 <- rls_temp2[Lat95_temp2[, .(taxon, period, abun_95, Lat95, Lon95, site95, Temp95)], on= .(taxon, period)]
```

###### Join subsets
```{r}
# Gather all subsets
rls <- rbind(rls_trop, rls_temp1, rls_temp2) #nrow = 101,044
```

### Producing a working dataset

#### Restructure dataset 
```{r}
## Order by limit and category
# Abundance weighted quantiles
rls_trop_N_wt <- rls[guild == "tropical", 
                     .(taxon, class, guild, presence, 
                       site_code, latitude, longitude, N_site,
                       period, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat05,
                       lat_abun = abun_5,
                       lon = Lon05,
                       site = site05,
                       temp = Temp05,
                       limit = "northern",
                       side = "both")]
rls_temp_N_wt <- rls[guild == "temperate", 
                     .(taxon, class, guild, presence, 
                       site_code, latitude, longitude, N_site,
                       period, side, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat05,
                       lat_abun = abun_5,
                       lon = Lon05,
                       site = site05,
                       temp = Temp05,
                       limit = "northern")]

rls_S_wt <- rls[guild == "tropical" | taxon %in% temp_1side$taxon, 
                .(taxon, class, guild, presence,
                  site_code, latitude, longitude, N_site,
                  period, side, year_i, year_f, dt,
                  total, mean_sst, 
                  lat = Lat95,
                  lat_abun = abun_95,
                  lon = Lon95,
                  site = site95,
                  temp = Temp95,
                  limit = "southern")]
rls_temp_S_wt <- rls[taxon %in% temp_2side$taxon, 
                     .(taxon, class, guild, presence,
                       site_code, latitude, longitude, N_site,
                       period, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat95,
                       lat_abun = abun_95,
                       lon = Lon95,
                       site = site95,
                       temp = Temp95,
                       limit = "southern",
                       side = "both")]

rls <- rbind(rls_trop_N_wt, rls_temp_N_wt, rls_S_wt, rls_temp_S_wt) #nrow = 202,088
```


#### Calculate changes in periods
```{r}
### Calculate latitudinal changes for each species' limits, dispersion index and population trends
rls_summary_t1 <- rls[period == "t1", 
                      .(lat1 = unique(lat), lon1 = unique(lon), site1 = unique(site), 
                        temp1 = unique(temp), 
                        total_log1 = log(unique(lat_abun)) + 1),
                      by = .(taxon, limit,
                             side,
                             # include factors of interest
                             class, guild, presence, 
                             N_site)] # nrow = 1,968


rls_summary_t2 <- rls[period == "t2", 
                      .(lat2 = unique(lat), lon2 = unique(lon), site2 = unique(site), 
                        temp2 = unique(temp), 
                        total_log2 = log(unique(lat_abun)) + 1),
                      by = .(taxon, limit,
                             side,
                             #include factors of interest
                             class, guild, presence, 
                             N_site)] # nrow = 2,098

rls_summary <- rls_summary_t1[rls_summary_t2, on = .(taxon, 
                                                     side,
                                                     class, guild, presence, limit)] #nrow = 1,950

rls_summary <- rls_summary[, ':=' (dLat = lat2 - lat1,
                                   dLon = lon2 - lon1,
                                   dTemp = temp2 - temp1,
                                   pop_trend = total_log2 - total_log1)]

rls_summary <- rls_summary[!is.na(dLat)] #nrow = 1,931

# Organize dataset
rls_summary <- rls_summary[, .(taxon, class, 
                               guild, limit, 
                               side,
                               lat1, lat2, dLat,
                               lon1, lon2, dLon,
                               site1, site2, N_site,
                               temp1, temp2, dTemp,
                               total_log1, total_log2, pop_trend,
                               presence)]
```

#### Add traits of interest
```{r}
# Rename and join traits of interest
rls_summary <- rls_summary[traits[, .(taxon = `CURRENT_SPECIES_NAME`,
                                      range = `Range`,
                                      trophic_level = `Trophic Level`,
                                      trophic_group = `Trophic group2`,
                                      max_length = `MaxLength`,
                                      water_column = `Water column`,
                                      habitat = `Habitat`,
                                      max_depth = `Max depth`,
                                      therm_max = `Thermal_95thmax`,
                                      therm_mid = `ThermalMP_5_95`,
                                      sgi = `SGI`)], on = .(taxon), nomatch = NULL]

# Add family
rls_summary <- rls.raw[, .(family = unique(family)), by = .(taxon)][rls_summary, on = .(taxon), nomatch = NULL] #nrow = 1,934
```


#### Add bioregions based on latitude and longitude extremes
```{r}
rls_summary <- rls_summary[, region:= ifelse(lat1 > -20.5 & lon1 < 147, "N",
                                             ifelse(lat1 < -20.5 & lon1 < 117, "SW",
                                                    ifelse(lat1 %between% c(-40, -30) & lon1 %between% c(120, 147), "S",
                                                           ifelse(lat1 %between% c(-40, -25) & lon1 > 147, "SE", 
                                                                  ifelse(lat1 > -25 & lon1 > 147, "N", "TAS"))))),
                           by = .(taxon, limit)]
```

#### Add dSST data
```{r}
# Merge site data and SST by survey_id
rls_sites <- rls.raw[site_code %in% c(rls_summary$site1, rls_summary$site2)][, lapply(.SD, unique), by = .(survey_id, survey_date), .SDcols = c("site_code", "latitude", "longitude")][sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL] #nrow = 16,609

rls_sites <- rls_sites[!is.na(mean_sst)] #nrow = 11,625

rls_sites[, ':=' (year_i = min(year(survey_date)),
                  year_f = max(year(survey_date))),
          by = .(site_code)]

rls_sites <- rls_sites[year(survey_date) == year_i, .(sst_t1 = mean(mean_sst)),
                       by = .(site_code, latitude, longitude)][rls_sites[year(survey_date) == year_f, .(sst_t2 = mean(mean_sst)),
                                                                         by = .(site_code)], on = .(site_code)] #nrow = 838

rls_sites[, dSST:= sst_t2 - sst_t1]

# Add dSST data
rls_summary <- rls_summary[rls_sites[, .(latitude, longitude, dSST), by = .(site1 = site_code)], on= .(site1),
                           nomatch = NULL] #nrow = 1,934
```


#### Remove dodgy limits/species errors and save dataset
```{r}
# Remove species that are errors
errors <- c("Atypichthys strigatus", "Cheilodipterus quinquelineatus", "Chelmonops truncatus", "Chromis nitida", "Cirripectes castaneus", "Cirripectes chelomatus", "Cirripectes filamentosus", "Cirripectes hutchinsi", "Cirripectes stigmaticus", "Comanthus tasmaniae", "Dotalabrus aurantiacus", "Echinostrephus aciculatus", "Enneapterygius atrogulare", "Enneapterygius rufopileus", "Enneapterygius similis", "Eocallionymus papilio", "Fusigobius duospilus", "Fusigobius neophytus", "Gnatholepis anjerensis", "Gnatholepis cauerensis", "Gobiodon quinquestrigatus", "Halichoeres erdmanni", "Holothuria whitmaei", "Istigobius rigilius", "Parapercis pacifica", "Parapercis queenslandica", "Pteraeolidia ianthina", "Thalassoma purpureum", "Tropiometra afra", "Orectolobus halei", "Oxycomanthus bennetti")

rls_summary <- rls_summary[!which(taxon %in% errors)] #nrow = 1,846

# Save dataset for corrections and checking of species limits
write.csv(rls_summary[order(taxon)], "rls_summary.csv", row.names = FALSE)
```

#### Plots
```{r}
# Remove unnecessary datasets
rm(Lat05_temp1,
   Lat05_temp2,
   Lat05_trop,
   Lat95_temp1,
   Lat95_temp2,
   Lat95_trop,
   Latskew_temp1,
   Latskew_temp2,
   Latskew_trop,
   rls_S_wt,
   rls_summary_t1,
   rls_summary_t2,
   rls_temp_N_wt,
   rls_temp_S_wt,
   rls_temp1,
   rls_temp2,
   rls_temp2_NO,
   rls_temp2_S,
   rls_trop,
   rls_trop_N_wt,
   species_list,
   temp_1side,
   temp_2side)

# Create factors
rls_summary <- rls_summary[, ':=' (guild = factor(guild, levels = c("tropical", "temperate")),
                                   class = factor(ifelse(class %in% c("Actinopterygii", "Elasmobranchii"), "fish", "invertebrate"), levels = c("fish", "invertebrate")),
                                   presence = factor(presence, levels = c("common", "rare")),
                                   water_column = factor(water_column),
                                   trophic_group = factor(trophic_group),
                                   habitat = factor(ifelse(habitat == "Coral", "coral",
                                                           ifelse(habitat == "Sand", "sand", habitat)), levels = c("coral", "rock", "sand", "water column")),
                                   region = factor(region, levels = c("N", "SW", "S", "SE", "TAS")),
                                   limit = factor(limit, levels = c("northern", "southern")))]
```

##### Introductory figure
```{r}
library(patchwork)
library(cowplot)
library(ggpubr)


#### ---- Decadal SST map
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

site_sst <- fread("../Raw Data/site_sst_yearly.csv") #nrows = 12,570

# Add coordinates
site_sst <- site_sst[rls[, .(latitude = unique(latitude), longitude = unique(longitude)), by = .(site_code)], on = .(site_code), nomatch = NULL]

# Linear regression to obtain mean SST change throughout the decade
site_sst <- site_sst[, .(sst_lm = list(lm(mean_sst ~ year)),
                           year_i = min(year),
                           year_f = max(year),
                           latitude = mean(latitude),
                           longitude = mean(longitude)),
                       by = .(site_code)]

# Extract sst_t1, sst_t2 and dSST
site_sst <- site_sst[, ':=' (sst_t1 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_i,
                               sst_t2 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_f,
                               dSST = sst_lm[[1]]$coefficients["year"]),
                       by = .(site_code)]

#rls_sites <- rls_sites[, dSST:= sst_t2 - sst_t1, by = .(site_code)]


# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_sites_sf <- st_as_sf(site_sst, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")
pnts$dSST <- pnts$dSST * 10 # convert units to dSST/decade

# Plot
aus_map <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_sites, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.2, 0.7, 0.2),
                       limits = c(-0.2, 0.7)) +
  
  # regional divisions
  geom_spoke(aes(x = 115, y = -21.5, angle = 90, radius = 11), linewidth = 1) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 1) +
  geom_segment(aes(x = 153, y = -26, xend = 160, yend = -26), linewidth = 1) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 1) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "a"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "b"), fontface = "bold") +
  geom_text(aes(x = 130, y = -35, label = "c"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "d"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "e"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 165), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST per decade (°C)", x = NULL, y = NULL, colour = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal") 



####---- Histograms

# Set guild color scheme
guild_cols <- c(tropical = "#F8766D",
                temperate = "#00BFC4")

# Categorize shifts
rls_summary[, dir:= ifelse(dLat > 1, "north", 
                           ifelse(dLat < -1, "south",
                                  "static"))]

# Need to make sure both plots have the same latitudes and same bins

region_plots <- list()
for(i in rls_summary[, unique(region)]){
  
  # Subset data
  data_p1 <- rls_summary[dir != "static" & region == i]
  data_p1[, N:= .N, by = .(limit)]
  
  ## Create histogram
  p1 <- ggplot(data_p1[N > 3],
               aes(y = lat1, fill = dir)) + 
    geom_histogram(binwidth = 2, boundary = 1, position = "dodge") +
    facet_grid(limit ~.) +
    labs(x = "", y = "Latitude", subtitle = ifelse(i == "N", "a",
                                                   ifelse(i == "SW", "b",
                                                          ifelse(i == "S", "c", 
                                                                 ifelse(i == "SE", "d", "e"))))) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          strip.text = element_blank()) +
    guides(fill = "none")
  
  ## Create gradient plot
  
  # Seperate TAS plot
  if(i == "TAS"){
    
    data_p2 <- data.table(region = c("TAS", "TAS", "TAS"),
                          limit = c("southern", "southern", "southern"),
                          lat1 = c(-40, -42, -44),
                          dSST = c(0.5, 0.5, 0.01))
  }
  else{
    
    data_p2 <- data_p1[N > 3][, .(dSST = mean(dSST)), by = .(region, limit, lat1 = round(lat1, 0.2))]
    
  }
  
  # Calculate the y-axis limits from p1
  y_range <- ggplot_build(p1)$layout$panel_scales_y[[1]]$range$range
  
  p2 <- ggplot(data_p2,
               aes(x = region, y = lat1, fill = dSST)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                         midpoint = 0,
                         breaks = seq(signif(min(data_p2$dSST), 1), 
                                      signif(max(data_p2$dSST), 1),
                                      length.out = 5),
                         limits = c(signif(min(data_p2$dSST), 1), signif(max(data_p2$dSST), 1))) +
    facet_grid(limit ~.) +
    ylim(y_range) +
    labs(y = "Latitude") +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid = element_blank())
  
  # Adjust the heights of p1 and p2
  p1 <- p1 + coord_cartesian(ylim = y_range) +
    theme(plot.margin = margin(1, 1, 0.5, 0.5, "cm")) +
    plot_layout(heights = c(1))  # Adjust the height as needed
  
  p2 <- p2 + coord_cartesian(ylim = y_range) +
    theme(plot.margin = margin(0.5, 1, 1, 0.5, "cm")) +
    plot_layout(heights = c(1))  # Adjust the height as needed
  
  # Combine plots
  p3 <- p1 + p2 +
    plot_layout(guides = "collect", # Collect guides from both plots
                widths = c(0.8, 0.2)) # make gradient plot thinner
  
  # Add to list of region plots
  region_plots[[i]] <- p3 
}




#### ---- Main figure

# Collate next to aus_map
intro_plot <-
  ggarrange(aus_map, 
            wrap_plots(region_plots[c(5, 4, 1, 2, 3)]), 
            ncol = 2, widths = c(0.3, 1))

# Collate around aus_map
intro_plot2 <- 
  plot_grid(region_plots$SW, region_plots$N, region_plots$SE,
          region_plots$S, aus_map, region_plots$TAS,
          ncol = 3, nrow = 2,
          widths = c(0.8, 0.8, 0.8,
                     0.8, 0.3, 0.8),
          heights = c(0.3, 0.3, 0.3,
                      0.3, 1, 0.3))

# Collate next to aus_map
top_fig <- wrap_plots(region_plots[c(5, 1, 3)])
bottom_fig <- wrap_plots(region_plots[c(4, 2)]) + aus_map

intro_plot <-
  top_fig + bottom_fig +
  plot_layout(nrow = 2)
            

ggsave(plot = intro_plot, 
       "/figures/intro_plot.png", device = "png", 
       width = 180,  units = "mm", 
       dpi = 300)
```

##### Summary Plots
```{r}
## Main data distribution

# Violin plot
rls_summary_vp <- ggplot(rls_summary, aes(x = guild, y = dLat, fill = guild)) +
  geom_violin() +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~., scales = 'free') +
  labs(y = "Changes in latitudinal limits (° latitude)", subtitle = "a", x = "") +
  theme_bw() +
  guides(fill = "none")


# Averages
rls_means_wt <- rls_summary[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                              dTemp_mean = mean(dTemp),
                              dTemp_sd = sd(dTemp),
                              dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                            by = .(limit, guild)]
# Dotplot
rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = guild, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(x = "", y = "Mean changes in latitudinal limits (° latitude)", subtitle = "b") +
  theme_bw() +
  guides(colour = "none")

# Regression
rls_summary_regression <- ggplot(rls_summary, aes(x = dSST, y = dLat, col = guild)) +
  geom_point(col = "grey", alpha = 0.5) +
  geom_smooth(method = "glm") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ guild, scales = 'free') +
  labs(x = "Changes in sea-surface temperature (°C)", y = "Changes in latitudinal limits (° latitude)", subtitle = "c") +
  geom_text(data = rls_summary[limit == "northern" & guild == "tropical"],
            aes(x = -2.7, y = -7, label = "p < 0.05"),
            hjust = 0, vjust = -1, color = "black") +
  geom_text(data = rls_summary[limit == "southern" & guild == "tropical"],
            aes(x = -2.7, y = -15, label = "p = 0.05"),
            hjust = 0, vjust = -1, color = "black") +
  theme_bw() +
  theme(strip.text.x = element_blank()) +
  guides(colour = "none")

limits <- c("northern", "southern")

reg_models <- data.table() # empty data.table
for(j in unique(rls_summary$guild)){
  for(i in 1:length(limits)){
    
    ## fit models without log transformation
    data_limit <- rls_summary[limit == limits[i]][guild == j]
    
    M_limit <- lm(dLat ~ dSST, 
                  data = data_limit)
    
    LRT_limit <- drop1(M_limit, test = "Chisq")
    
    limit_dt <- data.table(limit = limits[i], 
                           guild = j, 
                           model = list(M_limit),
                           AIC = LRT_limit[2, ]$AIC, 
                           RSS = LRT_limit[2, ]$RSS,
                           slope = M_limit$coefficients["dSST"],
                           p.val = LRT_limit[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    reg_models <- rbind(reg_models, limit_dt)
    
  }
}

# Both tropical trends are significant -> evidence that northern limit is highly significant

ggarrange(ggarrange(rls_summary_vp, rls_means_plot_wt,
                    nrow = 1),
          rls_summary_regression,
          nrow = 2)
```



##### Temperature maps
```{r}
#### ----- Temperature maps
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

## Decadal temperature change
site_sst <- fread(paste0(dir, "/Raw Data/site_sst_yearly.csv")) #nrows = 12,570

# Add coordinates
site_sst <- site_sst[rls[, .(latitude = unique(latitude), longitude = unique(longitude)), by = .(site_code)], on = .(site_code), nomatch = NULL]

# Linear regression to obtain mean SST change throughout the decade
site_sst <- site_sst[, .(sst_lm = list(lm(mean_sst ~ year)),
                           year_i = min(year),
                           year_f = max(year),
                           latitude = mean(latitude),
                           longitude = mean(longitude)),
                       by = .(site_code)]

# Extract sst_t1, sst_t2 and dSST
site_sst <- site_sst[, ':=' (sst_t1 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_i,
                               sst_t2 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_f,
                               dSST = sst_lm[[1]]$coefficients["year"]),
                       by = .(site_code)]

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_sites_sf <- st_as_sf(site_sst, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")
pnts$dSST <- pnts$dSST * 10 # convert units to dSST/decade

# Plot
aus_map <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_sites, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.2, 0.7, 0.2),
                       limits = c(-0.2, 0.7)) +
  
  # regional divisions
  geom_spoke(aes(x = 115, y = -21.5, angle = 90, radius = 11), linewidth = 1) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 1) +
  geom_segment(aes(x = 153, y = -26, xend = 160, yend = -26), linewidth = 1) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 1) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "N"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "SW"), fontface = "bold") +
  geom_text(aes(x = 130, y = -35, label = "S"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "SE"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "TAS"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 165), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST per decade (°C)", x = NULL, y = NULL, colour = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal") 

## Site-level temperature change

rls_sites_sf <- st_as_sf(rls_summary[rls_summary[, .(dSST), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dSST = mean(dSST)), by = .(site1, longitude, latitude)], coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")

# Plot
site_level_heatmap <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_summary, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-2.3, 2, 0.8),
                       limits = c(-2.3, 2)) +
  
  # regional divisions
  geom_spoke(aes(x = 115, y = -21.5, angle = 90, radius = 11), linewidth = 1) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 1) +
  geom_segment(aes(x = 153, y = -26, xend = 160, yend = -26), linewidth = 1) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 1) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "N"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "SW"), fontface = "bold") +
  geom_text(aes(x = 130, y = -35, label = "S"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "SE"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "TAS"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST (°C)", x = NULL, y = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal")

# Bar plots with proportions
rls_barplot <- rls_summary
rls_barplot[, move:= ifelse(abs(dLat) > 1 & limit == "northern",
                            "northern moving",
                            ifelse(abs(dLat) > 1 & limit == "southern",
                                   "southern moving", "static"))]

limit_barplot <- ggplot(rls_barplot, aes(x = region,  fill = move)) +
  geom_bar(position = "dodge") +
  labs(x = "") +
  facet_wrap(guild ~.) +
  theme_bw() +
  guides(fill = "none")

# Collate plots
library(ggpubr)

ggarrange(ggarrange(aus_map, site_level_heatmap,
                    nrow = 1),
          limit_barplot,
          nrow = 2)
```



##### Regional map with means
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

site_sst <- fread(paste0(dir, "/Raw Data/site_sst_yearly.csv")) #nrows = 12,570

# Add coordinates
site_sst <- site_sst[rls[, .(latitude = unique(latitude), longitude = unique(longitude)), by = .(site_code)], on = .(site_code), nomatch = NULL]

# Linear regression to obtain mean SST change throughout the decade
site_sst <- site_sst[, .(sst_lm = list(lm(mean_sst ~ year)),
                           year_i = min(year),
                           year_f = max(year),
                           latitude = mean(latitude),
                           longitude = mean(longitude)),
                       by = .(site_code)]

# Extract sst_t1, sst_t2 and dSST
site_sst <- site_sst[, ':=' (sst_t1 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_i,
                               sst_t2 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year"] * year_f,
                               dSST = sst_lm[[1]]$coefficients["year"]),
                       by = .(site_code)]

#rls_sites <- rls_sites[, dSST:= sst_t2 - sst_t1, by = .(site_code)]


# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_sites_sf <- st_as_sf(site_sst, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")
pnts$dSST <- pnts$dSST * 10 # convert units to dSST/decade

# Plot
aus_map <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_sites, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.2, 0.7, 0.2),
                       limits = c(-0.2, 0.7)) +
  
  # regional divisions
  geom_spoke(aes(x = 115, y = -21.5, angle = 90, radius = 11), linewidth = 1) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 1) +
  geom_segment(aes(x = 153, y = -26, xend = 160, yend = -26), linewidth = 1) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 1) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "a"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "b"), fontface = "bold") +
  geom_text(aes(x = 130, y = -35, label = "c"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "d"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "e"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 165), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST per decade (°C)", x = NULL, y = NULL, colour = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal") 

# Regional means
rls_means_region <- rls_summary[, 
                                .(N = NROW(dLat),
                                  dLat_mean = mean(dLat),
                                  dLat_sd = sd(dLat),
                                  dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                                by = .(limit, guild, region)]


# Check if means are different to 0 using t-tests
rls_ttest <- rls_summary[rls_means_region[, .(N), by = .(region, limit, guild)], on = .(region, limit, guild)][N > 10][, .(p.val = t.test(dLat, mu = 0)$p.val), by = .(region, limit, guild)]

# investigate holm corrections; adjusts significance equally amongst groups
rls_ttest$Signif <- abs(rls_ttest$p.val) < 0.05
rls_ttest$p.value.bonf.adjust <- p.adjust(rls_ttest$p.val, method = 'bonferroni')
rls_ttest$p.value.holm.adjust <- p.adjust(rls_ttest$p.val, method = 'holm')
rls_ttest$p.value.bh.adjust <- p.adjust(rls_ttest$p.val, method = 'BH')

# Mark significant means on dataset
rls_means_region <- rls_means_region[rls_ttest[, .(Signif), by = .(limit, guild, region)], on = .(limit, guild, region)]

# Plot
rls_means_region_plot <- 
  ggplot(rls_means_region[N > 10],
         aes(x = region, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  geom_text(aes(label = paste("N =", N)),
              size = 4, 
              hjust = 1.3,
              col = "black") +
  geom_text(label = ifelse(rls_means_region$Signif == TRUE, "*", ""), 
            col = "black",
            size = 5, 
            hjust = 0.9, vjust = -1.2) +
  facet_grid(limit ~.) +
  labs(y = "Mean changes in latitudinal limits (° latitude)") +
  ylim(c(-1.2, 1.6)) +
  theme_bw() +
  theme(axis.title.x = element_blank()) +
  guides(colour = "none") 




# Set guild color scheme
guild_cols <- c(tropical = "#F8766D",
                temperate = "#00BFC4")

rls_summary <- rls_summary[, N:= .N, by = .(limit, guild, region)]

library(cowplot)

significant_guilds <- data.frame(
  region = c("N", "SW", "TAS"),
  limit = c("southern", "southern", "southern"),
  guild = c("tropical", "tropical", "temperate"),
  y_pos = c(-0.4, 0.4, 0.2),
  label = c("*", "*", "*")
)

regions <- c("N", "SW", "S", "SE", "TAS")
# Create a list to store the final plots for each region
region_plots <- list()

# Generate the final plot for each region
for (i in 1:length(regions)) {
  # Create dotplot plot; use means with more than 10 data points
  current_data <- rls_means_region[region == regions[i] & N > 10]

  p1 <- ggplot(current_data, aes(x = guild, y = dLat_mean, col = guild)) +
    geom_point(position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                      ymax = dLat_mean + dLat_se),
                  width = 0.2, position = position_dodge(width = 0.3)) +
    scale_color_manual(values = guild_cols) + 
    geom_text(aes(label = paste("N =", N)),
              size = 4, 
              hjust = 1.3,
              col = "black") +
    geom_hline(yintercept = 0, lty = "dashed") +
    facet_grid(limit ~ .) +
    labs(y = "", x = "", subtitle = ifelse(regions[i] == "NA", "a", 
                                           ifelse(regions[i] == "S", "b",
                                                  ifelse(regions[i] == "S", "c",
                                                         ifelse(regions[i] == "SE", "d", "e"))))) +
    guides(colour = "none") +
    theme_bw() +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
  
  # Filter the significant guilds for the current region and limit
  current_significant_guilds <- significant_guilds[significant_guilds$region == regions[i] &
                                                    significant_guilds$limit == "southern", ]
  
  # Add asterisks to the plot for significant guilds
  p1 <- p1 +
    geom_text(data = current_significant_guilds,
              aes(x = guild, y = y_pos, label = label),
              color = "black")

  # Store the final plot for the current region
  region_plots[[regions[i]]] <- p1
}

# Create figure with map and dot plots
plot_grid(
  plot_grid(NULL, region_plots$WA, region_plots$SA, ncol = 1),
  plot_grid(region_plots$`NA`, NULL, aus_map, ncol = 1, 
            rel_heights = c(1, 0, 2),
            rel_widths = c(1, 0, 2)),
  plot_grid(NULL, region_plots$SE, region_plots$TAS, ncol = 1),
  ncol = 3
)


#### ---- USE CODE BELOW TO ADD DOT PLOTS AND REGRESSIONS INTO ONE FIGURE

regions <- c("NA", "WA", "SA", "SE", "TAS")
# Create a list to store the final plots for each region
region_plots <- list()

# Generate the final plot for each region
for (i in 1:length(regions)) {
  
  # Create regression plot
  p1 <- ggplot(rls_summary[N > 30 & region == regions[i]], 
                          aes(x = dSST, y = dLat, col = guild)) +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    scale_color_manual(values = guild_cols) +
    facet_grid(limit ~ .) +
    theme_bw() +
    guides(colour = "none") +
    theme(strip.text = element_blank())

  # Create dotplot plot; use means with more than 10 data points
  p2 <- ggplot(rls_means_region[region == regions[i] & N > 10], 
                       aes(x = guild, y = dLat_mean, col = guild)) +
    geom_point(position = position_dodge(width = 0.3)) +
    geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                      ymax = dLat_mean + dLat_se),
                  width = 0.2, position = position_dodge(width = 0.3)) +
    scale_color_manual(values = guild_cols) + 
    geom_text(aes(label = paste("N =", N)),
              size = 4, 
              hjust = 1.3,
              col = "black") +
    geom_hline(yintercept = 0, lty = "dashed") +
    facet_grid(limit ~ .) +
    labs(y = "", X = "") +
    guides(colour = "none") +
    theme_bw() +
    theme(axis.text.y = element_blank())

  # Combine the two plots using cowplot
  p3 <- plot_grid(p1, p2,
                       labels = ifelse(regions[i] == "NA", "a",
                                       ifelse(regions[i] == "WA", "b",
                                              ifelse(regions[i] == "SA", "c", 
                                                     ifelse(regions[i] == "SE", "d", "e")))),
                       ncol = 2,
                       align = "h",
                       axis = "lr",
                       rel_widths = c(2, 1))

  # Store the final plot for the current region
  region_plots[[regions[i]]] <- p3
}

# Add TAS plots
p1 <- ggplot(rls_summary[limit == "southern" & region == "TAS"], 
             aes(x = dSST, y = dLat, col = guild)) +
  geom_smooth(method = "glm") + 
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) +
  facet_grid(limit ~ class) +
  theme_bw() +
  guides(colour = "none") +
  theme(strip.text.y = element_blank())

# Create dotplot plot
p2 <- ggplot(rls_summary[region == "TAS" & limit == "southern", 
                         .(N = NROW(dLat),
                           dLat_mean = mean(dLat),
                           dLat_sd = sd(dLat),
                           dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                           dTemp_mean = mean(dTemp),
                           dTemp_sd = sd(dTemp),
                           dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                         by = .(limit, guild, class)], 
             aes(x = class, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)),
            size = 4, 
            hjust = 1.3,
            col = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ .) +
  labs(y = "") +
  guides(colour = "none") +
  theme_bw() 

# Combine the two plots using cowplot
p3 <- plot_grid(p1, p2,
                labels = "e",
                ncol = 2,
                align = "h",
                axis = "lr",
                rel_widths = c(2, 1))

# Add to plotlist
region_plots[["TAS"]] <- p3

plot_grid(
  plot_grid(NULL, region_plots$WA, region_plots$SA, ncol = 1),
  plot_grid(region_plots$`NA`, NULL, aus_map, ncol = 1, rel_heights = c(1, 0, 2)),
  plot_grid(NULL, region_plots$SE, region_plots$TAS, ncol = 1),
  ncol = 3
)

```

##### TAS invert plot
```{r}
# Get means
rls_summary[, mean(dLat, na.rm = T), by = .(class)]

# Plot the data with boxplots and jitter
tas1 <- ggplot(rls_summary[region == "TAS" & limit == "southern"], 
               aes(x = class, y = dLat)) +
  geom_boxplot() +
  geom_jitter(aes(size = max_depth, col = presence), alpha = 0.7) +
  
  # Add the mean values as text labels to the plot
  geom_text(data = rls_summary[region == "TAS" & limit == "southern" & class == "fish"], 
            aes(x = class, y = 3,
                label = "mean = -0.07"), 
            size = 4, 
            hjust = 1.3,
            col = "black") +
  geom_text(data = rls_summary[region == "TAS" & limit == "southern" & class == "invertebrate"], 
            aes(x = class, y = 3,
                label = "mean = 0.11"),
            size = 4, 
            hjust = 1.3,
            col = "black") +
  
  # Add a dashed horizontal line at y = 0
  geom_hline(yintercept = 0, lty = "dashed") +
  labs(y = "Changes in latitudinal limits (° latitude)", x = "") +
  theme_bw() +
  guides(fill = "none")

# Tasmania temperature plot
tas_sites <- rls.raw[site_code %in% c(rls_summary[region == "TAS"]$site1, rls_summary[region == "TAS"]$site2)][, lapply(.SD, unique), by = .(survey_id, survey_date), .SDcols = c("site_code", "latitude", "longitude")][sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL] 

tas_sites <- tas_sites[!is.na(mean_sst)] 

tas2 <- ggplot(tas_sites[site_code != "BMP-S11", .(mean_sst = mean(mean_sst)), by = .(survey_date)], aes(x = survey_date, y = mean_sst)) + 
  geom_line() + 
  geom_smooth(method = "glm") +
  labs(y = "Average temperature (°C)", x = "") +
  theme_bw()

ggarrange(tas1 + theme(legend.position = "top"), tas2,
          ncol = 1, nrow = 2, 
          heights = c(1, 0.3))

```

##### Top 25% most abundant species
```{r}
# 697 species; 25% is roughly 174
abun_taxon <- rls[, .(taxon = unique(taxon)), by = .(N_site)][order(-N_site)][1:174]

rls_summary_abun <- rls_summary[taxon %in% abun_taxon$taxon] # nrow = 506

ggplot(rls_summary_abun, aes(x = dSST, y = dLat)) +
  geom_point(col = "grey", alpha = 0.5) +
  geom_smooth(aes(col = guild), method = 'glm') +
  facet_grid(limit ~ guild, scales = 'free') +
  theme_bw()

limits <- c("northern", "southern")

abun_models <- data.table() # empty data.table
for(j in unique(rls_summary_abun$guild)){
  for(i in 1:length(limits)){
    
    ## fit models without log transformation
    data_limit <- rls_summary_abun[limit == limits[i]][guild == j]
    
    M_limit <- lm(dLat ~ dSST, 
                  data = data_limit)
    
    LRT_limit <- drop1(M_limit, test = "Chisq")
    
    limit_dt <- data.table(limit = limits[i], 
                           guild = j, 
                           model = list(M_limit),
                           AIC = LRT_limit[2, ]$AIC, 
                           RSS = LRT_limit[2, ]$RSS, 
                           p.val = LRT_limit[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    abun_models <- rbind(abun_models, limit_dt)
    
  }
}

# No trends are significant

# By region
rls_summary_abun <- rls_summary_abun[, !("N")]
rls_summary_abun <- rls_summary_abun[rls_summary_abun[, .N, by = .(guild, limit, region)], on = .(guild, limit, region)]

ggplot(rls_summary_abun[N > 10], aes(x = dSST, y = dLat)) +
  geom_point(col = "grey", alpha = 0.5) +
  geom_smooth(aes(col = guild), method = 'glm') +
  facet_grid(limit ~ region + guild, scales = 'free') +
  theme_bw()

# Think about seperating fish and invertebrates


means_region_top25 <- rls_summary_abun[, 
                                       .(N = NROW(dLat),
                                         dLat_mean = mean(dLat),
                                         dLat_sd = sd(dLat),
                                         dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                                       by = .(limit, guild, region)]

means_region_top25_plot <- ggplot(means_region_top25,
                                aes(x = class, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ region) +
  labs(y = "Mean changes in latitudinal limits (° latitude)") +
  theme_bw() +
  guides(colour = "none")

# Check if means are different to 0 using t-tests
means_region_ttest <- rls_summary_abun[means_region_top25[, .(N), by = .(region, limit, guild)], on = .(region, limit, guild)][, .(p.val = t.test(dLat, mu = 0)$p.val), by = .(region, limit, guild)]

# investigate holm corrections; adjusts significance equally amongst groups
means_region_ttest$p.value.holm.adjust <- p.adjust(means_region_ttest$p.val, method = 'holm')
means_region_ttest$Signif <- abs(means_region_ttest$p.value.holm.adjust) < 0.05

```

##### IDW maps
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

# Site-level temperature change
rls_sites_sf <- st_as_sf(rls_summary[rls_summary[, .(dSST), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dSST = mean(dSST)), by = .(site1, longitude, latitude)], coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")

# Plot
site_level_heatmap <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_summary, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-2.3, 2, 0.8),
                       limits = c(-2.3, 2)) +
  
  # regional divisions
  geom_segment(aes(x = 114, y = -23, xend = 110, yend = -23), linewidth = 2) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 2) +
  geom_segment(aes(x = 150, y = -23, xend = 160, yend = -23), linewidth = 2) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 2) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "a"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "b"), fontface = "bold") +
  geom_text(aes(x = 130, y = -36, label = "c"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "d"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "e"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST (°C)", x = NULL, y = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal")  


# Northern limit dLat
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "northern"][rls_summary[limit == "northern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatN_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.82, 2.2, 0.6),
                       limits = c(-0.82, 2.2)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: N", subtitle = "a") +
  theme_bw()

# Southern
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "southern"][rls_summary[limit == "southern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatS_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-3.3, 4.1, 1.48),
                       limits = c(-3.3, 4.1)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: S", subtitle = "b") +
  theme_bw()


# CTI maps
rls_cti <- rls[taxon %in% rls_summary$taxon & site_code %in% rls_sites$site_code][traits[, .(thermal_mid = `ThermalMP_5_95`), by = .(taxon = `CURRENT_SPECIES_NAME`)], on = .(taxon), nomatch = NULL]

rls_cti <- rls_cti[, .(taxon = unique(taxon)), by = .(site_code, latitude, longitude, period, thermal_mid)]

rls_cti <- rls_cti[period == "t1", .(cti_t1 = mean(thermal_mid, na.rm = T)), by = .(site_code, latitude, longitude)][rls_cti[period == "t2", .(cti_t2 = mean(thermal_mid, na.rm = T)), by = .(site_code, latitude, longitude)], on = .(site_code, latitude, longitude)]

rls_cti[, dCTI:= cti_t2 - cti_t1]

rls_cti <- rls_cti[!is.na(dCTI)]

rls_cti <- rls_cti[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

rls_cti <- rls_cti[, region:= ifelse(latitude > -23, "NA",
                                             ifelse(latitude < -23 & longitude < 120, "WA",
                                                    ifelse(latitude %between% c(-40, -30) & longitude %between% c(120, 147), "SA",
                                                           ifelse(latitude %between% c(-40, -23) & longitude > 147, "SE", 
                                                                  ifelse(latitude > -23 & longitude > 147, "NA", "TAS"))))),
                           by = .(site_code)]

# Create simple features objects and a spatial grid for interpolation
rls_dCTI <- rls_cti[, .(longitude, latitude, dCTI)]
rls_dCTI_sf <- st_as_sf(rls_dCTI, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dCTI ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dCTI_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dCTI")

# Plot
dCTI_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dCTI)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.6, 0.6, 0.24),
                       limits = c(-0.6, 0.6)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dCTI", subtitle = "c") +
  theme_bw()


# CTI maps
rls_cgi <- rls[taxon %in% rls_summary$taxon & site_code %in% rls_sites$site_code][traits[, .(sgi = `SGI`), by = .(taxon = `CURRENT_SPECIES_NAME`)], on = .(taxon), nomatch = NULL]

rls_cgi <- rls_cgi[, .(taxon = unique(taxon)), by = .(site_code, latitude, longitude, period, sgi)]

rls_cgi <- rls_cgi[period == "t1", .(cgi_t1 = mean(sgi, na.rm = T)), by = .(site_code, latitude, longitude)][rls_cgi[period == "t2", .(cgi_t2 = mean(sgi, na.rm = T)), by = .(site_code, latitude, longitude)], on = .(site_code, latitude, longitude)]

rls_cgi[, dCGI:= cgi_t2 - cgi_t1]

rls_cgi <- rls_cgi[!is.na(dCGI)]

rls_cgi <- rls_cgi[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

rls_cgi <- rls_cgi[, region:= ifelse(latitude > -23, "NA",
                                             ifelse(latitude < -23 & longitude < 120, "WA",
                                                    ifelse(latitude %between% c(-40, -30) & longitude %between% c(120, 147), "SA",
                                                           ifelse(latitude %between% c(-40, -23) & longitude > 147, "SE", 
                                                                  ifelse(latitude > -23 & longitude > 147, "NA", "TAS"))))),
                           by = .(site_code)]

# Create simple features objects and a spatial grid for interpolation
rls_dCGI <- rls_cgi[, .(longitude, latitude, dCGI)][!is.na(dCGI)]
rls_dCGI_sf <- st_as_sf(rls_dCGI, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dCGI ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dCGI_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dCGI")

# Plot
dCGI_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dCGI)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-3, 3, 1.2),
                       limits = c(-3, 3)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dCGI", subtitle = "d") +
  theme_bw()


# Collate all maps
ggarrange(dLatN_plot, dCTI_plot,
          dLatS_plot, dCGI_plot,
          nrow = 2, ncol = 2)

####---- East Coast flux map

# Northern limit dLat
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "northern"][rls_summary[limit == "northern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 3][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatN_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.8, 1.6, 0.5),
                       limits = c(-0.8, 1.6)) +
  
  scale_x_continuous(breaks = seq(140, 160, by = 10), limits = c(140, 160), label = paste0(seq(140, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: N", subtitle = "Northern limit flux") +
  theme_bw()

# Southern
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "southern"][rls_summary[limit == "southern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 3][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatS_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-3.5, 2.8, 1.3),
                       limits = c(-3.5, 2.8)) +
  
  scale_x_continuous(breaks = seq(140, 160, by = 10), limits = c(140, 160), label = paste0(seq(140, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: S", subtitle = "Southern limit flux") +
  theme_bw()

# Collate plots
ggarrange(dLatN_plot, dLatS_plot,
          nrow = 1, ncol = 2)

```


##### dSST regression plots
```{r}
rls <- rls[, region:= ifelse(latitude > -23, "NA",
                                             ifelse(latitude < -23 & longitude < 120, "WA",
                                                    ifelse(latitude %between% c(-40, -30) & longitude %between% c(120, 147), "SA",
                                                           ifelse(latitude %between% c(-40, -23) & longitude > 147, "SE", 
                                                                  ifelse(latitude > -23 & longitude > 147, "NA", "TAS"))))),
                           by = .(taxon, limit)]

# Select the 10 northernmost sites for each species' limits
ext_sites_N <- rls[period == "t1", .(site_code = unique(site_code)), by = .(latitude, taxon, side, period)][order(taxon, side, period, -latitude)][, .SD[1:10], by = .(taxon, side)]

# Add dSST data
ext_sites_N <- ext_sites_N[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

# Calculate mean dSST for all extreme sites for each species
ext_sites_N <- ext_sites_N[, .(dSST = mean(dSST)), by = .(taxon, side)]

# Add dLat values
ext_sites_N <- ext_sites_N[rls_summary[limit == "northern", .(dLat, region, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi), by = .(taxon, side)], on = .(taxon, side)]

# Select the 10 southernmost sites for each species' limits
ext_sites_S <- rls[period == "t1", .(site_code = unique(site_code)), by = .(latitude, taxon, side, period)][order(taxon, side, latitude)][, .SD[1:10], by = .(taxon, side)]

# Add dSST data
ext_sites_S <- ext_sites_S[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

# Calculate mean dSST for all extreme sites for each species
ext_sites_S <- ext_sites_S[, .(dSST = mean(dSST)), by = .(taxon, side)]

# Add dLat values
ext_sites_S <- ext_sites_S[rls_summary[limit == "southern", .(dLat, region, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi), by = .(taxon, side)], on = .(taxon, side)]

ext_sites_N <- ext_sites_N[, .(taxon, guild, side, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi, region, dLat, dSST, limit = "northern")]

ext_sites_S <- ext_sites_S[, .(taxon, guild, side, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi, region, dLat, dSST, limit = "southern")]

ext_sites <- rbind(ext_sites_N, ext_sites_S)

# dLat vs dSST regression
dLat_dSST_plot <- ggplot(ext_sites,
                         aes(x = dSST, y = dLat, col = guild)) +
  geom_smooth(method = 'glm') +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ class) +
  labs(title = "") +
  theme_bw() +
  guides(color = "none")

# dLat vs dSST regression by region
regions <- c("NA", "WA", "SA", "SE", "TAS")

ext_sites <- ext_sites[, N:= .N, by = .(limit, guild, region)]

# Create individual scatterplots
reg_plots <- lapply(regions, function(var) {
  ggplot(ext_sites[N > 50][region == var], 
         aes(x = dSST, y = dLat, col = guild)) +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    scale_color_manual(values = guild_cols) +
    facet_grid(limit ~.) +
    labs(subtitle = var) +
    theme_bw() +
    guides(colour = "none")
})

# Display the scatterplots
reg_plots <- ggarrange(plotlist = reg_plots, ncol = 3, nrow = ceiling(length(reg_plots) / 3))

# dLat vs dSST regression by trophic_group
trophic_group <- levels(ext_sites$trophic_group)

ext_sites <- ext_sites[, N:= .N, by = .(limit, guild, trophic_group, class)]

# Create individual scatterplots
troph_plots <- lapply(trophic_group, function(var) {
  ggplot(ext_sites[N > 10][trophic_group == var], 
         aes(x = dSST, y = dLat, col = guild)) +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    scale_color_manual(values = guild_cols) +
    facet_grid(limit ~ class) +
    labs(subtitle = var) +
    theme_bw() +
    guides(colour = "none")
})

# Display the scatterplots
troph_plots <- ggarrange(plotlist = troph_plots, ncol = 3, nrow = ceiling(length(troph_plots) / 3))

# dLat vs dSST regression by water column
water_column <- levels(ext_sites$water_column)

ext_sites <- ext_sites[, N:= .N, by = .(limit, guild, water_column, class)]

# Create individual scatterplots
watcol_plots <- lapply(water_column, function(var) {
  ggplot(ext_sites[N > 10][water_column == var], 
         aes(x = dSST, y = dLat, col = guild)) +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    scale_color_manual(values = guild_cols) +
    facet_grid(limit ~ class) +
    labs(subtitle = var) +
    theme_bw() +
    guides(colour = "none")
})

# Display the scatterplots
watcol_plots <- ggarrange(plotlist = watcol_plots, ncol = 3, nrow = ceiling(length(watcol_plots) / 3))

# dLat vs dSST regression by habitat
habitat <- levels(ext_sites$habitat)

ext_sites <- ext_sites[, N:= .N, by = .(limit, guild, habitat, class)]

# Create individual scatterplots
hab_plots <- lapply(habitat, function(var) {
  ggplot(ext_sites[N > 10][habitat == var], 
         aes(x = dSST, y = dLat, col = guild)) +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    scale_color_manual(values = guild_cols) +
    facet_grid(limit ~ class) +
    labs(subtitle = var) +
    theme_bw() +
    guides(colour = "none")
})

# Display the scatterplots
hab_plots <- ggarrange(plotlist = hab_plots, ncol = 3, nrow = ceiling(length(hab_plots) / 3))

# Subsets showing expected dLat ~ dSST relationships are:
# NA trop N
# (WA trop S)
# WA temp N
# SA temp N
# SA temp S
# SE temp S
# (TAS temp S)

# GAM model to test traits
library(mgcv)
library(lme4)

# Note gam/glm might not run with NAs (pop_trend, trophic_level & SGI)
gam(dLat ~ dSST + pop_trend + presence + range + trophic_level + trophic_group + (log(max_length) + 1) + water_column + habitat + therm_max + therm_mid + sgi,
    data = ext_sites[region == "NA" & limit == "northern" & guild == "tropical" | region == "WA" & limit == "northern" & guild == "temperate" | region == "SA" & limit == "northern" & guild == "temperate" | region == "SA" & limit == "southern" & guild == "temperate" | region == "SE" & limit == "southern" & guild == "temperate" | region == "WA" & limit == "southern" & guild == "tropical" | region == "TAS" & limit == "southern" & guild == "temperate"])

# Factors of interest with dSST:
# region | presence | trophic group

NA_reg <- ggplot(ext_sites[region == "NA" & limit == "northern" & guild == "tropical" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "NA northern limits") +
  guides(col = "none") +
  theme_bw()

WA_reg <- ggplot(ext_sites[region == "WA" & limit == "northern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "WA northern limits") +
  guides(col = "none") +
  theme_bw()

SA_reg <- ggplot(ext_sites[region == "SA" & limit == "southern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "SA southern limits") +
  guides(col = "none") +
  theme_bw()

TAS_reg <- ggplot(ext_sites[region == "TAS" & limit == "southern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "TAS southern limits") +
  guides(col = "none") +
  theme_bw()

ggarrange(
  ggarrange(NA_reg,
            WA_reg,
            nrow = 2, ncol = 1),
  ggarrange(SA_reg,
            TAS_reg,
            nrow = 2, ncol = 1),
  nrow = 1, ncol = 2)

rls_summary_wide <-  rls_summary[limit == "northern", .(latN = lat1), by = .(taxon)][rls_summary[limit == "southern", .(latS = lat1), by = .(taxon)], on = .(taxon)]
```

##### Functional groups
```{r}
# Functional groups
functional_groups <- data.table(
  size = rep(c("small", "medium", "large", "giant"), each = 5 * 4),
  water_column = rep(rep(levels(rls_summary[, unique(water_column)])), each = 5),
  trophic_group = rep(levels(rls_summary[, unique(trophic_group)])),
  fcn_grp = c("small benthic invertivore",
              "small benthic corallivore",
              "small benthic herbivore",
              "small benthic carnivore",
              "small benthic planktivore",
              "small demersal invertivore",
              "small demersal corallivore",
              "small demersal herbivore",
              "small demersal carnivore",
              "small demersal planktivore",
              "small pelagic non-site attached invertivore",
              "small pelagic non-site attached corallivore",
              "small pelagic non-site attached herbivore",
              "small pelagic non-site attached carnivore",
              "small pelagic non-site attached planktivore",
              "small pelagic site attached invertivore",
              "small pelagic site attached corallivore",
              "small pelagic site attached herbivore",
              "small pelagic site attached carnivore",
              "small pelagic site attached planktivore",
              "medium benthic invertivore",
              "medium benthic corallivore",
              "medium benthic herbivore",
              "medium benthic carnivore",
              "medium benthic planktivore",
              "medium demersal invertivore",
              "medium demersal corallivore",
              "medium demersal herbivore",
              "medium demersal carnivore",
              "medium demersal planktivore",
              "medium pelagic non-site attached invertivore",
              "medium pelagic non-site attached corallivore",
              "medium pelagic non-site attached herbivore",
              "medium pelagic non-site attached carnivore",
              "medium pelagic non-site attached planktivore",
              "medium pelagic site attached invertivore",
              "medium pelagic site attached corallivore",
              "medium pelagic site attached herbivore",
              "medium pelagic site attached carnivore",
              "medium pelagic site attached planktivore",
              "large benthic invertivore",
              "large benthic corallivore",
              "large benthic herbivore",
              "large benthic carnivore",
              "large benthic planktivore",
              "large demersal invertivore",
              "large demersal corallivore",
              "large demersal herbivore",
              "large demersal carnivore",
              "large demersal planktivore",
              "large pelagic non-site attached invertivore",
              "large pelagic non-site attached corallivore",
              "large pelagic non-site attached herbivore",
              "large pelagic non-site attached carnivore",
              "large pelagic non-site attached planktivore",
              "large pelagic site attached invertivore",
              "large pelagic site attached corallivore",
              "large pelagic site attached herbivore",
              "large pelagic site attached carnivore",
              "large pelagic site attached planktivore",
              "giant benthic invertivore",
              "giant benthic corallivore",
              "giant benthic herbivore",
              "giant benthic carnivore",
              "giant benthic planktivore",
              "giant demersal invertivore",
              "giant demersal corallivore",
              "giant demersal herbivore",
              "giant demersal carnivore",
              "giant demersal planktivore",
              "giant pelagic non-site attached invertivore",
              "giant pelagic non-site attached corallivore",
              "giant pelagic non-site attached herbivore",
              "giant pelagic non-site attached carnivore",
              "giant pelagic non-site attached planktivore",
              "giant pelagic site attached invertivore",
              "giant pelagic site attached corallivore",
              "giant pelagic site attached herbivore",
              "giant pelagic site attached carnivore",
              "giant pelagic site attached planktivore")
)

# Add size catefory to summary subset
rls_summary[, size:= ifelse(max_length < 15, "small",
                            ifelse(max_length %between% c(16, 30), "medium",
                                   ifelse(max_length %between% c(31, 45), "large", "giant")))]

# Join functional groups
rls_summary <- rls_summary[functional_groups, on= .(size, water_column, trophic_group), nomatch = NULL]

# Classify species as expected vs non expected based on a 0.5 degree cutoff
rls_summary <- rls_summary[, trend:= factor(ifelse(dSST < -0.5 & dLat > 0 | dSST > 0.5 & dLat < 0, "expected",
                                            ifelse(dSST < -0.5 & dLat < 0 | dSST > 0.5 & dLat > 0, "contrary", "static")))]

# Select the 10 most common functional groups
ggplot(rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = dSST, y = dLat)) +
  geom_point(col = "grey", alpha = 0.5) +
  geom_smooth(aes(col = guild), method = 'glm') +
  facet_grid(limit ~ guild) +
  theme_bw()

ggplot(rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = fcn_grp, y = dLat)) +
  geom_boxplot() +
  facet_grid(limit ~ guild) +
  theme_bw()

fcn_grp_means <- rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                            by = .(limit, fcn_grp)]
# Dotplot
fcngrp_means_plot <- ggplot(fcn_grp_means,
                            aes(x = fcn_grp, y = dLat_mean)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(x = "", y = "Mean changes in latitudinal limits (° latitude)", subtitle = "b") +
  theme_bw() +
  guides(colour = "none")

# Giant demersal herbivore and large demersal herbivore stand out, but not sure what that means -> also majority of data is herbivore and invertivore

##### --------
# Functional groups
functional_groups <- data.table(
  size = rep(c("small", "large"), each = 5 * 4),
  water_column = rep(rep(levels(factor(rls_summary[, unique(water_column)]))), each = 5),
  trophic_group = rep(levels(factor(rls_summary[, unique(trophic_group)]))),
  fcn_grp = c("small benthic invertivore",
              "small benthic corallivore",
              "small benthic herbivore",
              "small benthic carnivore",
              "small benthic planktivore",
              "small demersal invertivore",
              "small demersal corallivore",
              "small demersal herbivore",
              "small demersal carnivore",
              "small demersal planktivore",
              "small pelagic non-site attached invertivore",
              "small pelagic non-site attached corallivore",
              "small pelagic non-site attached herbivore",
              "small pelagic non-site attached carnivore",
              "small pelagic non-site attached planktivore",
              "small pelagic site attached invertivore",
              "small pelagic site attached corallivore",
              "small pelagic site attached herbivore",
              "small pelagic site attached carnivore",
              "small pelagic site attached planktivore",
              "large benthic invertivore",
              "large benthic corallivore",
              "large benthic herbivore",
              "large benthic carnivore",
              "large benthic planktivore",
              "large demersal invertivore",
              "large demersal corallivore",
              "large demersal herbivore",
              "large demersal carnivore",
              "large demersal planktivore",
              "large pelagic non-site attached invertivore",
              "large pelagic non-site attached corallivore",
              "large pelagic non-site attached herbivore",
              "large pelagic non-site attached carnivore",
              "large pelagic non-site attached planktivore",
              "large pelagic site attached invertivore",
              "large pelagic site attached corallivore",
              "large pelagic site attached herbivore",
              "large pelagic site attached carnivore",
              "large pelagic site attached planktivore")
)

# Add size catefory to summary subset
rls_summary[, size:= ifelse(max_length < 30, "small", "large")]

# Join functional groups
rls_summary <- rls_summary[functional_groups, on= .(size, water_column, trophic_group), nomatch = NULL]

# Classify species as expected vs non expected based on a 0.5 degree cutoff
rls_summary <- rls_summary[, trend:= factor(ifelse(dSST < -0.5 & dLat > 0 | dSST > 0.5 & dLat < 0, "expected",
                                            ifelse(dSST < -0.5 & dLat < 0 | dSST > 0.5 & dLat > 0, "contrary", "static")))]

# Reorder by descending order of functional group and trend
rls_summary$trend <- factor(rls_summary$trend, levels = c("expected", "contrary", "static"))
rls_summary$fcn_grp <- factor(rls_summary$fcn_grp, levels = rls_summary[trend == "expected", .N, by = fcn_grp][order(-N)]$fcn_grp)

# Plot barplot
ggplot(rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = fcn_grp)) +
    geom_bar() +
    facet_grid(trend ~.) +
    theme_bw()


# Select the 10 most common functional groups
ggplot(rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = dSST, y = dLat)) +
  geom_point(col = "grey", alpha = 0.5) +
  geom_smooth(aes(col = guild), method = 'glm') +
  facet_grid(limit ~ guild) +
  theme_bw()

ggplot(rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = fcn_grp, y = dLat)) +
  geom_boxplot() +
  facet_grid(limit ~ guild) +
  theme_bw()

fcn_grp_means <- rls_summary[fcn_grp %in% rls_summary[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                            by = .(limit, fcn_grp)]
# Dotplot
fcngrp_means_plot <- ggplot(fcn_grp_means,
                            aes(x = fcn_grp, y = dLat_mean)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(x = "", y = "Mean changes in latitudinal limits (° latitude)", subtitle = "b") +
  theme_bw() +
  guides(colour = "none")

#### ----  Try using top 25% species

# Add size catefory to summary subset
rls_summary_abun[, size:= ifelse(max_length < 30, "small", "large")]

# Join functional groups
rls_summary_abun <- rls_summary_abun[functional_groups, on= .(size, water_column, trophic_group), nomatch = NULL]

# Classify species as expected vs non expected based on a 0.5 degree cutoff
rls_summary_abun <- rls_summary_abun[, trend:= factor(ifelse(dSST < -0.5 & dLat > 0 | dSST > 0.5 & dLat < 0, "expected",
                                            ifelse(dSST < -0.5 & dLat < 0 | dSST > 0.5 & dLat > 0, "contrary", "static")))]

# Reorder by descending order of functional group and trend
rls_summary_abun$trend <- factor(rls_summary_abun$trend, levels = c("expected", "contrary", "static"))
rls_summary_abun$fcn_grp <- factor(rls_summary_abun$fcn_grp, levels = rls_summary_abun[trend == "expected", .N, by = fcn_grp][order(-N)]$fcn_grp)


ggplot(rls_summary_abun[fcn_grp %in% rls_summary_abun[, .N, by = .(fcn_grp)][order(-N)][1:10]$fcn_grp],
       aes(x = fcn_grp)) +
    geom_bar() +
    facet_grid(trend ~.) +
    theme_bw()
```

##### Traits investigation
```{r}
# Classify species as expected vs non expected based on a 0.5 degree cutoff
rls_traits <- rls_summary[, trend:= factor(ifelse(dSST < -0.5 & dLat > 0.5 | dSST > 0.5 & dLat < -0.5, "expected",
                                            ifelse(dSST < -0.5 & dLat < -0.5 | dSST > 0.5 & dLat > 0.5, "not expected", "static")))]

# Scale the data and Check for normality
rls_traits$range_scaled <- scale(rls_traits$range) 
rls_traits$max_length_scaled <- scale(rls_traits$max_length) 
rls_traits$therm_max_scaled <- scale(rls_traits$therm_max)
rls_traits$sgi_scaled <- scale(rls_traits$sgi)

hist(rls_traits$range_scaled) # skewed to the left
hist(rls_traits$max_length) # skewed to the left
hist(rls_traits$therm_max_scaled) # bimodal
hist(rls_traits$sgi_scaled)

# Do I need to transform the data?

# Tukeys test
library(multcomp)

fit <- aov(range_scaled ~ 1 + trend, data = rls_traits)

summary(glht(fit, linfct = mcp(trend = "Tukey")))

# Therm_max; stat vs not expected
# SGI; stat vs expected

ggplot(rls_traits, aes(x = trend, y = range_scaled)) +
  geom_boxplot()

# Average trait values by trend
rls_summary <- rls_summary[, lapply(.SD, function(x){mean(scale(x, center = T, scale = T), 
                                                          na.rm = T)}), 
                 by = .(trend),
                 .SDcols = c("range", "max_length", "therm_max", "sgi")]

#          trend    range max_length therm_max      sgi
#1:       static 2387.757   33.31801  29.24990 14.54516
#2:     expected 2170.720   34.31411  28.73240 11.91585
#3: not expected 2190.659   36.75037  27.92359 13.50954


library(glmmTMB)
library(summarytools) #provides more detailed summaries

#### Prepare data  ----
# Create a subset with traits of interest
rls_traits <- rls_summary[, .(taxon, class, family,
                              presence,
                              guild, 
                              limit, 
                              dLat, 
                              dSST, 
                              region, 
                              range, 
                              max_length, 
                              max_depth, 
                              therm_max, 
                              sgi, 
                              trophic_group, 
                              water_column)] #nrow = 1,846

# Standardize quantitative varaibles
rls_traits$dLat_scaled <- scale(rls_traits$dLat, center = TRUE, scale = TRUE)
rls_traits$dSST_scaled <- scale(rls_traits$dSST, center = TRUE, scale = TRUE)
rls_traits$range_scaled <- scale(rls_traits$range, center = TRUE, scale = TRUE)
rls_traits$maxlength_scaled <- scale(rls_traits$max_length, center = TRUE, scale = TRUE)
rls_traits$maxdepth_scaled <- scale(rls_traits$max_depth, center = TRUE, scale = TRUE)
rls_traits$thermmax_scaled <- scale(rls_traits$therm_max, center = TRUE, scale = TRUE)
rls_traits$sgi_scaled <- scale(rls_traits$sgi, center = TRUE, scale = TRUE)

# Convert factors to numeric values
rls_traits$guild_num <- as.numeric(as.factor(rls_traits$guild))
rls_traits$presence_num <- as.numeric(as.factor(rls_traits$presence))
rls_traits$trophic_group_num <- as.numeric(rls_traits$trophic_group)
rls_traits$water_column_num <- as.numeric(rls_traits$water_column)

# Trait data for invertebrates is incomplete, split datasets
fish_traits <- rls_traits[class == "fish"] #nrow = 1,611
invert_traits <- rls_traits[class == "invertebrate"] #nrow = 235

# remove all NAs
fish_traits <- na.omit(fish_traits) #nrow = 1,403

# view the data using summary tools
view(dfSummary(fish_traits))

#### Plot data in pairs to see relationship between them ----

# Plot all traits to visualize data
plot(fish_traits[, .(dLat, dSST, range, max_length, max_depth, sgi, therm_max, guild, presence, trophic_group, water_column)]) # raw data

plot(fish_traits[, .(dLat, dSST, range_scaled, maxlength_scaled, maxdepth_scaled, sgi_scaled, thermmax_scaled, guild_num, presence_num, trophic_group_num, water_column_num, move_num)]) # scaled data

# create correlation matrix
fish_cor_matrix     <- cor(fish_traits[,.(range, max_length, max_depth, sgi, therm_max, guild_num, presence_num, trophic_group_num, water_column_num)])

#inverts_cor_matrix <- cor(na.omit(invert_traits[,.(range, max_length, max_depth, therm_max, guild_num, trophic_group_num, water_column_num)]))

# plot matrix
library(corrplot)
library(RColorBrewer)

dir.create(paste0(dir, '/chapter1/figures'), recursive = T)
pdf("figures/fish_trait_cor.pdf", height = 6, width = 6)
corrplot(fish_cor_matrix, type="upper", method = c('number'),
         col=brewer.pal(n=11, name="PuOr"), tl.col = 'black',rect.col = 'white')
dev.off()

# Correlated variables:
# range and therm_max
# range and guild
# SGI and presence

# check some obvious relationships
plot(fish_traits$trophic_group_num, fish_traits$max_length)
plot(fish_traits$trophic_group_num, log(fish_traits$max_length))


#### Plot data into panels for warming, cooling, southern and northern ----

# Convert continuous variables into factors
fish_traits$dSST_sign <- factor(sign(fish_traits$dSST), labels = c('cooling', 'warming'))
fish_traits$sgi_scaled_factor <- factor(fish_traits$sgi_scaled < quantile(fish_traits$sgi_scaled, 0.5), labels = c('generalist', 'specialist'))
fish_traits$range_scaled_factor <- factor(fish_traits$range_scaled < quantile(fish_traits$range_scaled, 0.5), labels = c('large ranged', 'small ranged'))
fish_traits$max_length_factor <- factor(fish_traits$maxlength_scaled < quantile(fish_traits$maxlength_scaled, 0.5), labels = c('large size', 'small size'))
fish_traits$max_depth_factor <- factor(fish_traits$maxdepth_scaled < quantile(fish_traits$maxdepth_scaled, 0.5), labels = c('deep', 'shallow'))
fish_traits$therm_max_factor <- factor(fish_traits$thermmax_scaled < quantile(fish_traits$thermmax_scaled, 0.5), labels = c('warm threshold', 'cool threshold'))

# dLat ~ dSST scatterplot
ggplot(fish_traits, aes(x = dSST, y = dLat)) +
  geom_point() +
  geom_smooth(method = "glm") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ dSST_sign, scales = 'free_x') +
  theme_bw()


traits <- c("guild", "presence", "range_scaled_factor", "max_length_factor", "max_depth_factor", "therm_max_factor", "sgi_scaled_factor", "trophic_group", "water_column")

# Create individual scatterplots
trait_plots <- lapply(traits, function(var) {
  ggplot(fish_traits, 
         aes(x = dSST, y = dLat, col = get(var))) +
    geom_point() +
    geom_smooth(method = "glm") + 
    geom_hline(yintercept = 0, lty = "dashed") +
    facet_grid(limit ~., scales = 'free_x') +
    labs(subtitle = var) +
    theme_bw()
})

# Display the scatterplots
trait_plots <- ggarrange(plotlist = trait_plots, ncol = 3, nrow = ceiling(length(trait_plots) / 3))

#### Fit models to find best random effect structure ----

# NULL MODELS - HERE WE WANT TO REMOVE ALL OF THE FIXED EFFECTS AND 
# ONLY TEST FOR DIFFERENCES AMONGST RANDOM EFFECT STRUCTURES
M0_dLat <- glmmTMB(dLat ~ 1,
                   data = fish_traits, REML = T)
M1_dLat <- glmmTMB(dLat ~ 1 + (1|family),
                   data = fish_traits, REML = T)
anova(M0_dLat, M1_dLat) 

# NO SUPPORT THAT FAMILY EXPLAINS SUBSTANTIAL VARIATION IN RESPONSES

#         Df    AIC    BIC  logLik deviance  Chisq Chi Df Pr(>Chisq)
#M0_dLat  2 6483.1 6493.6 -3239.5   6479.1                         
#M1_dLat  3 6484.7 6500.5 -3239.4   6478.7 0.3663      1      0.545


#### Fit models with no traits
----

limits <- c("northern", "southern")

simple_models <- data.table() # empty data.table
for(j in unique(fish_traits$dSST_sign)){
  for(i in 1:length(limits)){
    
    ## fit models without log transformation
    data_limit <- fish_traits[limit == limits[i]][dSST_sign == j]
    
    M_limit <- lm(dLat ~ dSST, 
                  data = data_limit)
    
    cooksd <- cooks.distance(M_limit)
    data_noOutliers <- data_limit[which(cooksd < 4*cooksd),]
    
    M_limit <- lm(dLat ~ dSST, 
                  data = data_noOutliers)
    
    LRT_limit <- drop1(M_limit, test = "Chisq")
    
    limit_dt <- data.table(limit = limits[i], 
                           temp_change = j, 
                           model = list(M_limit),
                           AIC = LRT_limit[2, ]$AIC, 
                           RSS = LRT_limit[2, ]$RSS, 
                           p.val = LRT_limit[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    simple_models <- rbind(simple_models, limit_dt)
    
  }
}



#### Fit models to each trait to determine the effects of each variable ----

### fit without random effects
limits <- c("northern", "southern")

traits_models <- data.table() # empty data.table
for(j in unique(fish_traits$dSST_sign)){
for(i in 1:length(limits)){
  for(trait in traits){
    
    ## fit models without log transformation
    data_limit <- fish_traits[limit == limits[i]][dSST_sign == j]
    
    # data_limit <- data_limit %>% filter(dLat != 0)
    
    formula <- paste("dLat ~ dSST *", trait)
    
    M_trait <- lm(as.formula(formula), 
                    data = data_limit)
    
    cooksd <- cooks.distance(M_trait)
    data_noOutliers <- data_limit[which(cooksd < 4*cooksd),]
    
    M_trait <- lm(as.formula(formula), 
                  data = data_noOutliers)
    
    LRT_trait <- drop1(M_trait, test = "Chisq")
    
    trait_dt <- data.table(limit = limits[i], 
                           temp_change = j,
                           trait = trait, 
                           model = list(M_trait),
                           AIC = LRT_trait[2, ]$AIC, 
                           RSS = LRT_trait[2, ]$RSS, 
                           p.val = LRT_trait[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    traits_models <- rbind(traits_models, trait_dt)
    
  }
}
}


# investigate holm corrections; adjusts significance level progressively based on the order of p-values as opposed to equally amongst traits
traits_models$p.value.holm.adjust <- p.adjust(traits_models$p.val, method = 'holm')
traits_models$Signif <- abs(traits_models$p.value.holm.adjust) < 0.05

# get those that are significant from the independent models
traits_models %>% filter(response == 'raw', p.value.holm.adjust < 0.05)
# limit        trait    model      AIC      RSS        p.val response p.value.holm.adjust
# 1: southern        guild <lm[13]> 1119.630 4083.872 0.0013860869      raw         0.041582608
# 2: southern range_scaled <lm[12]> 1119.084 4079.898 0.0002964478      raw         0.009486329
apply(traits_models %>% filter(response == 'raw', p.value.holm.adjust < 0.05), 1, function(x){
  z <- list(summary(x$model))
  names(z) <- paste(x$limit, x$temp_change, x$trait)
  return(z)
  })

apply(traits_models %>% filter(response == 'raw', p.value.holm.adjust < 0.05), 1, function(x){
  print(plot(x$model))
})



#### Test with robust regression ----

library(MASS)

### fit without random effects
limits <- c("northern", "southern")
traits <- c("guild", "presence", "range_scaled_factor", "max_length_factor", "max_depth_factor", "therm_max_factor", "sgi_scaled_factor", "water_column")


robust_models <- data.table() # empty data.table
for(j in unique(fish_traits$dSST_sign)){
for(i in 1:length(limits)){
  for(trait in traits){
    
    ## fit models without log transformation
    data_limit <- fish_traits[limit == limits[i]][dSST_sign == j]
    
    # data_limit <- data_limit %>% filter(dLat != 0)
    
    formula <- paste("dLat ~ dSST *", trait)
    
    M_trait <- rlm(as.formula(formula), 
                    method = "MM",
                   data = data_limit)
    
    #cooksd <- cooks.distance(M_trait)
    #data_noOutliers <- data_limit[which(cooksd < 4*cooksd),]
    
    #M_trait <- rlm(as.formula(formula), 
    #              data = data_noOutliers)
    
    LRT_trait <- drop1(M_trait, test = "Chisq")
    
    trait_dt <- data.table(limit = limits[i], 
                           temp_change = j,
                           trait = trait, 
                           model = list(M_trait),
                           AIC = LRT_trait[2, ]$AIC, 
                           RSS = LRT_trait[2, ]$RSS, 
                           p.val = LRT_trait[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    robust_models <- rbind(robust_models, trait_dt)
    
  }
}
}


# investigate holm corrections; adjusts significance level progressively based on the order of p-values as opposed to equally amongst traits
robust_models$p.value.holm.adjust <- p.adjust(robust_models$p.val, method = 'holm')
robust_models$Signif <- abs(robust_models$p.value.holm.adjust) < 0.05

# get those that are significant from the independent models
robust_models %>% filter(response == 'raw', p.value.holm.adjust < 0.05)


#### Test with GAM for heavy tailed dsitributions ----
library(mgcv)

### fit without random effects
limits <- c("northern", "southern")
traits <- c("guild", "presence", "range_scaled_factor", "max_length_factor", "max_depth_factor", "therm_max_factor", "sgi_scaled_factor", "trophic_group", "water_column")


gam_models <- data.table() # empty data.table
for(j in unique(fish_traits$dSST_sign)){
for(i in 1:length(limits)){
  for(trait in traits){
    
    ## fit models without log transformation
    data_limit <- fish_traits[limit == limits[i]][dSST_sign == j]
    
    # data_limit <- data_limit %>% filter(dLat != 0)
    
    formula <- paste("dLat ~ s(dSST *", trait, ")")
    
    M_trait <- gam(as.formula(formula),
                   #family = gaussian(link = "identity"),
                    data = data_limit)
    
    trait_dt <- data.table(limit = limits[i], 
                           temp_change = j,
                           trait = trait, 
                           model = list(M_trait),
                           p.val = M_trait[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    gam_models <- rbind(gam_models, trait_dt)
    
  }
}
}


# investigate holm corrections; adjusts significance level progressively based on the order of p-values as opposed to equally amongst traits
robust_models$p.value.holm.adjust <- p.adjust(robust_models$p.val, method = 'holm')
robust_models$Signif <- abs(robust_models$p.value.holm.adjust) < 0.05

# get those that are significant from the independent models
robust_models %>% filter(response == 'raw', p.value.holm.adjust < 0.05)





##### Test using region as random factor
#### Fit models to find best random effect structure ----

# NULL MODELS - HERE WE WANT TO REMOVE ALL OF THE FIXED EFFECTS AND 
# ONLY TEST FOR DIFFERENCES AMONGST RANDOM EFFECT STRUCTURES
M0_dLat <- glmmTMB(dLat ~ 1,
                   data = fish_traits, REML = T)
M1_dLat <- glmmTMB(dLat ~ 1 + (1|region),
                   data = fish_traits, REML = T)
anova(M0_dLat, M1_dLat) 

# REGION EXPLAINS SUBSTANTIAL VARIATION IN RESPONSES

#        Df    AIC    BIC  logLik deviance  Chisq Chi Df
#M0_dLat  2 6483.1 6493.6 -3239.5   6479.1              
#M1_dLat  3 6474.0 6489.8 -3234.0   6468.0 11.073      1
#          Pr(>Chisq)    
#M0_dLat               
#M1_dLat   0.000876 ***


#### Fit models with no traits
----
fish_traits[, N:= .N, by = .(limit, region)]
  
limits <- c("northern", "southern")

simple_models <- data.table() # empty data.table
for(i in 1:length(limits)){
    
    ## fit models without log transformation
    data_limit <- fish_traits[N > 10][limit == limits[i]]
    
    M_limit <- glmmTMB(dLat ~ dSST + (1|region), 
                  data = data_limit)
    
    LRT_limit <- drop1(M_limit, test = "Chisq")
    
    limit_dt <- data.table(limit = limits[i], 
                           model = list(M_limit),
                           AIC = LRT_limit[2, ]$AIC, 
                           RSS = LRT_limit[2, ]$RSS, 
                           p.val = LRT_limit[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    simple_models <- rbind(simple_models, limit_dt)
    
}



#### Fit models to each trait to determine the effects of each variable ----

### fit without random effects
limits <- c("northern", "southern")

traits_models <- data.table() # empty data.table
for(i in 1:length(limits)){
  for(trait in traits){
    
    ## fit models without log transformation
    data_limit <- fish_traits[N > 10][limit == limits[i]]
    
    # data_limit <- data_limit %>% filter(dLat != 0)
    
    formula <- paste("dLat ~ dSST *", trait, "+ (1|region)")
    
    M_trait <- glmmTMB(as.formula(formula), 
                       data = data_limit)
    
    LRT_trait <- drop1(M_trait, test = "Chisq")
    
    trait_dt <- data.table(limit = limits[i], 
                           trait = trait, 
                           model = list(M_trait),
                           AIC = LRT_trait[2, ]$AIC, 
                           RSS = LRT_trait[2, ]$RSS, 
                           p.val = LRT_trait[2, ]$`Pr(>Chi)`, 
                           response = 'raw')
    
    traits_models <- rbind(traits_models, trait_dt)
    
  }
}

# investigate holm corrections; adjusts significance level progressively based on the order of p-values as opposed to equally amongst traits
traits_models$p.value.holm.adjust <- p.adjust(traits_models$p.val, method = 'holm')
traits_models$Signif <- abs(traits_models$p.value.holm.adjust) < 0.05






##### FITTING TRAITS MODEL INDEPENDENTLY ----
### Testing structure of the random effects in our model ----

# no effect from phylogeny
M0_dLat <- glm(dLat ~ dSST,
                   data = rls_traits)

# Summary of M0: dSST has a negative effect on dLat p < 0.01
#Coefficients:
#            Estimate Std. Error t value Pr(>|t|)   
#(Intercept) -0.02878    0.05942  -0.484   0.6282   
#dSST        -0.16298    0.06079  -2.681   0.0074 **


# Control for the shared effect of species evolutionary histories
M1_dLat <- lmer(dLat ~ dSST + (1|family),
                   data = rls_traits, REML = T)

anova(M0_dLat, M1_dLat) 
# Lower residual deviance indicates a slightly better fit with random effects term
#     Df Deviance Resid. Df Resid. Dev
#NULL                  1845      11834
#dSST  1   45.955      1844      11788
  
# Control for the effects of dSST per family 
M2_dLat <- lmer(dLat ~ dSST + (dSST|family),
                   data = rls_traits, REML = F) #model does not converge if REML = T

anova(M1_dLat, M2_dLat) 
# No evidence for differences between models, but M1 is less complex
#        npar    AIC    BIC  logLik deviance  Chisq
#M1_dLat    4 8669.3 8691.4 -4330.6   8661.3       
#M2_dLat    6 8671.9 8705.0 -4329.9   8659.9 1.3737
#        Df Pr(>Chisq)
#M1_dLat              
#M2_dLat  2     0.5032
  
AIC(M1_site) # different to ANOVA above, suggesting a higher AIC value
AIC(M2_site)

### Test each trait metric
limits <- c("northern", "southern")

traits <- c("guild", "range_scaled", "maxlength_scaled", "maxdepth_scaled", "thermmax_scaled", "sgi_scaled", "trophic_group", "water_column")

traits_models <- data.table() # empty data.table
for(i in 1:length(limits)){
  for(trait in traits){
    
    formula <- paste("dLat ~ dSST *", trait, "+ (1|family)")
    
    M_trait <- lmer(as.formula(formula), 
                    data = rls_traits[limit == limits[i]],
                    REML = TRUE)
    
    LRT_trait <- drop1(M_trait, test = "Chisq")
    
    trait_dt <- data.table(limit = limits[i], trait = trait, model = c(M_trait), AIC = LRT_trait[2, ]$AIC, LRT = LRT_trait[2, ]$LRT, p.val = LRT_trait[2, ]$`Pr(Chi)`)
    
    traits_models <- rbind(traits_models, trait_dt)
  }
}  


### Bonferroni corrections on the p-values from seperate models ----

traits_models <- traits_models[, p.adj:= p.adjust(p.val, method = 'bonferroni'), # is the method bonferroni or Benjamini & Hochberg?
                               by = .(limit)]

traits_models[p.adj < 0.05]
# None
```



##### Temperate investigation
```{r}
# Create subset for temperate species
rls_temp <- rls.raw[, location:= ifelse(location == "Port Stephens - North", "Port Stephens", location)] # Combine Port Stephen locations

rls_temp <- rls_temp[taxon %in% rls_summary[presence == "common"]$taxon & location %in% c("Port Stephens", "Solitary Islands", "Maria Island", "D'Entrecasteaux & Derwent") & year(survey_date) >= 2010, .(total = sum(total)), 
                     by = .(taxon, year(survey_date), location)]

# Add traits
rls_temp <- rls_temp[traits[, .(taxon, therm_mid)], on = .(taxon), nomatch = NULL]
rls_temp[, guild:= ifelse(therm_mid > 23, "tropical",
                          ifelse(therm_mid %between% c(17, 23), "temperate warm", "temperate cold"))][!is.na(guild)]


# Convert to wide format to produce presence/absence data
rls_temp <- dcast(rls_temp, taxon + location + guild ~ year, fun.aggregate = function(x) length(x), value.var = "total") # NROW or length

#Convert to long format for manipulation
rls_temp <- melt(rls_temp, id.vars = c("taxon", "location", "guild"),
                 variable.name = "year",
                 value.name = "presence")

# Count number of species by location and year
rls_temp <- rls_temp[rls_temp[, .(N = sum(presence)), by = .(year, location, guild)], on = .(year, location, guild)][rls_temp[presence == 0, .(N_abs = NROW(taxon)), by = .(year, location, guild)], on = .(year, location, guild)]
rls_temp <- rls_temp[, year:= as.numeric(levels(year))[year]] #change factors to numeric

# Define first and last year surveyed for each location
rls_temp <- rls_temp[rls_temp[N > 0, .(year_t1 = min(year),
                      year_t2 = max(year)),
         by = .(location)], on = .(location)]

# Obtain initial, final and total number of species
rls_temp <- rls_temp[year == year_t1, .(N_t1 = unique(N)),
                     by = .(location, guild)][rls_temp, on = .(location, guild)]
rls_temp <- rls_temp[year == year_t2, .(N_t2 = unique(N)),
                     by = .(location, guild)][rls_temp, on = .(location, guild)]
rls_temp <- rls_temp[, .(Nmax = NROW(unique(taxon))),
         by = .(location, guild)][rls_temp, on = .(location, guild)]

# Calculate percentage change throughout time
#rls_temp <- rls_temp[year %between% c(2011, 2021) & N > 0]

rls_temp_t1 <- rls_temp[, 
                             .(taxon, location, guild,
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - N_t1) / N_t1 * 100,
                               compare_point = "t1")]

rls_temp_t2 <- rls_temp[, 
                             .(taxon, location, guild, 
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - N_t2) / N_t2 * 100,
                               compare_point = "t2")]
rls_temp_Nmax <- rls_temp[, 
                             .(taxon, location, guild,
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - Nmax) / Nmax * 100,
                               compare_point = "Nmax")]

rls_temp <- rbind(rls_temp_t1, rls_temp_t2, rls_temp_Nmax)

# Add dSST
rls_tempsites <- rls.raw[location %in% c("Port Stephens", "Solitary Islands", "Maria Island", "D'Entrecasteaux & Derwent")]

rls_tempsites <- rls_tempsites[sst_data, on = .(survey_id)]

rls_tempsites <- rls_tempsites[, .(mean_sst = mean(mean_sst)),
                       by = .(year(survey_date), location)]

rls_temp <- rls_temp[rls_tempsites, on = .(year, location), nomatch = NULL]

rls_temp$guild <- factor(rls_temp$guild, levels = c("tropical", "temperate warm", "temperate cold"))

write.csv(rls_temp, paste0(dir, "/chapter1/temp_timeseries.csv"), row.names = FALSE)

ggplot(rls_temp) +
  geom_line(aes(x = year, y = pct_change, col = guild, lty = compare_point)) +
  facet_wrap(vars(location))

# Create a plot with two y-axes
p1 <- ggplot(rls_temp, aes(x = year)) +
 
  geom_line(aes(y = N, col = guild)) +
  
  # Add temperature data and right y-axis
  #geom_line(aes(y = mean_sst * 10, color = "red", lty = "dashed")) +
  #scale_y_continuous(name = "Temperature", sec.axis = sec_axis(~ ./10, name = "Temperature (°C)")) +
  # Add x-axis label and plot title
  labs(x = "Year") +
  # Customize plot theme
  facet_grid(location ~ compare_point) +
  theme_bw()

p2 <- ggplot(rls_temp, aes(x = year, y = mean_sst, col= "red", lty = "dashed")) +
  geom_line() +
  facet_grid(location ~., scale = "free") +
  labs(x = "Year", y = "Temperature (°C)") +
  theme_bw() +
  guides(lty = "none", col = "none")

library(ggpubr)

ggarrange(p2, p1, 
          nrow = 1, ncol = 2,
          widths = c(1, 2))
```

##### Tropical species investigation
```{r}
# Divide species into native and non native Australian by latitude
rls_trop <- rls_summary[guild == "tropical"]
rls_trop_native <- rls_trop[limit == "northern", .(native = ifelse(lat1 < -15, "aus", "indo")), by = .(taxon)]
rls_trop <- rls_trop[rls_trop_native, on = .(taxon)]

ggplot(rls_trop, aes(x = therm_max, y = abs(dLat), col = native)) +
    geom_point() + 
  geom_smooth(method = 'glm') + 
  facet_grid(limit ~.)

glm(dLat ~ dSST + native + limit + (log(max_length) + 1) + presence + water_column + trophic_group + habitat + therm_max + sgi,
    data = rls_trop)

# Divide species into native and non native Australian by thermal max
rls_trop <- rls_summary[guild == "tropical"]
therm_threshold <- rls_sites[, max(sst_t1)]
rls_trop[, native:= ifelse(therm_mid < therm_threshold, "aus", "indo"), by = .(taxon)]
rls_trop <- rls_trop[!is.na(native)]

ggplot(rls_trop, aes(x = therm_max, y = abs(dLat), col = native)) +
    geom_point() + 
  geom_smooth(method = 'glm') + 
  facet_grid(limit ~.)

glm(dLat ~ dSST + native + limit + (log(max_length) + 1) + presence + water_column + trophic_group + habitat + therm_max + sgi,
    data = rls_trop)
```


##### Community thermal index
```{r}
ggplot(rls_summary, aes(x = therm_mid, y = dLat)) +
  geom_point() +
  geom_smooth() +
  facet_grid(guild ~ region)

glm(dLat ~ dSST + guild + limit + (log(max_length) + 1) + presence + habitat + water_column + trophic_group + max_depth + therm_mid + therm_max + sgi,
   data = rls_summary[region == "NA"])

#NA -> temperate, southern, max_length, habitat, trophic group

ggplot(rls_summary, aes(x = limit, y = dLat, col = guild)) +
  geom_boxplot() +
  facet_grid(region ~ presence)
```



##### Comparing extreme values
```{r}
rls_ext <- fread(paste0(dir, "/chapter1/rls_summary_ext.csv")) #nrows = 1,634,614

rls_summary[, type:= "normal"]
rls_ext[, type:= "extreme"]

rls_ext <- rls_ext[taxon %in% rls_summary$taxon]

rls_summary_both <- rls_summary[, !c(13, 21)][rls_ext[, .(dLat_ext = dLat), by = .(taxon, limit)], on = .(taxon, limit)][, dLat_dif:= dLat_ext - dLat, by = .(taxon, limit)]

rls_summary_comb <- rbind(rls_summary[, !c(13, 21)], rls_ext)
rls_summary_comb <- rls_summary_comb[taxon %in% rls_summary_both[abs(dLat_dif) > 3]$taxon]


rls_summary_comb <- rls_summary_comb[order(-type, limit, -dLat)]
rls_summary_comb$taxon <- factor(rls_summary_comb$taxon, levels = unique(rls_summary_comb$taxon))

ggplot(rls_summary_comb, aes(x = taxon, y = dLat, col = type, shape = guild)) +
  geom_point() +
  facet_grid(limit ~.)

# Averages
rls_means_wt <- rls_summary_comb[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                            by = .(limit, guild, type)]

rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = type, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Average latitudinal displacement of species limits") +
  theme_bw()

```


##### Species wallpaper
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Species wallpapers
taxon_list <- rls_summary[limit != "optimum"][order(-abs(dLat))][, .SD[1:50]]$taxon

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

ggplot() +
  # Rasters
  geom_sf(data = aus_sf) +
  
  # sites included in analysis
  geom_point(data = rls[limit != "optimum"][taxon %in% taxon_list], 
             aes(x = longitude, y = latitude, shape = side),
             size = 3) +
  
  # Select shapes to display
  scale_shape_manual(values = c("east" = 1, "west" = 2)) +
  
  # Limit lines
  geom_hline(data = rls[limit != "optimum"][taxon %in% taxon_list],
             aes(yintercept = lat, col = limit, lty = side)) +
  
  # East/west division
  geom_vline(xintercept = 142.5, lty = "dashed") +
  annotate("text", x = 150, y = -7, label = "east") +
  annotate("text", x = 132, y = -7, label = "west") +
  
  # Facet by taxon
  facet_wrap(vars(taxon, period)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  theme_bw()
```

```{r}
# Exploratory correlations

## Abundance plots
ggplot(rls_summary[limit != "optimum"], 
       aes(x = class, y = pop_trend, col = guild)) +
  geom_boxplot() +
  facet_grid(limit ~ side)

abun_table <- rls_summary[limit != "optimum", 
                          .(N = NROW(pop_trend),
                            pop_trend_mean = mean(pop_trend),
                            pop_trend_sd = sd(pop_trend),
                            pop_trend_se = sd(pop_trend) / sqrt(NROW(pop_trend))),
                          by = .(class, side, limit, guild)]

abun_plot <- ggplot(abun_table,
                         aes(x = class, y = pop_trend_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = pop_trend_mean - pop_trend_se,
                    ymax = pop_trend_mean + pop_trend_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ side) +
  labs(y = "Population trend", title = "Population trend following the 2016 heatwave") +
  theme_bw()


pop_trend_dSST_plot <- ggplot(rls_summary[limit != "optimum"],
                              aes(x = dSST, y = pop_trend, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(guild + class ~ side) +
  labs(labs = "Population trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

lm(
  pop_trend ~ 1 + dSST, data = rls_sites[, .(dSST), by = .(site = site_code)][rls_summary, on = .(site)][!is.na(dSST)][abs(pop_trend) != Inf][guild == "tropical"] 
)

## Thermal niche and SGIs

# Read thermal niche and SGI data
thermal_niche <- fread(paste0(dir, "/Raw Data/Thermal niche.csv")) #nrows = 4,465
sgi_dt <- fread(paste0(dir, "/Raw Data/SGIs.csv")) #nrows = 26,904

rls_summary_thermal <- thermal_niche[, .(taxon = `SPECIES_NAME`, upper_thermal = `95th percentile`)][rls_summary, on= .(taxon), nomatch = NULL]
rls_summary_SGI <- sgi_dt[, .(taxon = `SPECIES_NAME`, SGI)][rls_summary, on= .(taxon), nomatch = NULL]

# Divide native vs non-native Australian species based on upper thermal limit
# Set thermal threshold to the av annual temperature of the warmest site
thresh <- rls_sites[, max(sst_t1)]

rls_summary_thermal[, type:= ifelse(upper_thermal < thresh, "aus", "indo")]

# or split at latitude -15
rls_summary_thermal[limit == "northern", type2:= ifelse(lat1 < -15, "aus", "indo")]

stat_box_data <- function(y, upper_limit = max(rls_summary$dLat) * 1.15) {
  return( 
    data.frame(
      y = 0.95 * upper_limit,
      label = paste('N =', length(y), '\n',
                    'mean =', round(mean(y), 1), '\n')
    )
  )
}

N_limit_dist_plot <- ggplot(rls_summary_thermal[guild == "tropical" & limit == "northern"], 
       aes(x = type, y = dLat)) +
    geom_boxplot() +
    geom_hline(yintercept = 0, lty = "dashed") +
    stat_summary(
        fun.data = stat_box_data, 
        geom = "text", 
        hjust = 0.5,
        vjust = 0.9
    ) + 
  facet_wrap(vars(ecoregion)) +
    labs(y = "dLat", title = "Latitudinal changes before and after 2016 heatwave") +
    theme_bw()

therm_table <- rls_summary_thermal[guild == "tropical" & limit == "northern", 
                          .(N = NROW(dLat),
                            dLat_mean = mean(dLat),
                            dLat_sd = sd(dLat),
                            dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                          by = .(type, ecoregion)]

therm_plot <- ggplot(therm_table,
                         aes(x = type, y = dLat_mean)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(y = "", title = "") +
  theme_bw()


N_limit_thermal <- ggplot(rls_summary_thermal[limit == "northern" & guild == "tropical"],
                              aes(x = upper_thermal, y = dLat, col = type)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(x = "Upper thermal limit (C)") +
  theme_bw()

ggplot(rls_summary_SGI[limit == "northern" & guild == "tropical"],
                              aes(x = SGI, y = dLat)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(labs = "Ppopulation trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

# Collate plots

library(ggpubr)

N_limit_plots <- ggarrange(N_limit_dist_plot, N_limit_thermal,
                               nrow = 1, ncol = 2,
                               widths = c(1.4, 1))

# Species distribution curves

dist_curves <- rls[, .(lat = unique(lat), lat_abun = unique(lat_abun)),
                  by = .(taxon, side, limit, period)]

ggplot() +
  
  geom_point(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "blue") +
  geom_smooth(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), col = "blue",
             method = "loess") +
  
  geom_point(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "red") +
  geom_smooth(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), col = "red",
             method = "loess") +
  
  coord_flip() +
  
  facet_wrap(taxon ~ side, scales = "free") +
  
  theme_bw()
```


EXTRA STUFF
```{r}
# To include a change in range
# Calculate change in latitudinal range
rls_summary_range <- rls_summary[limit == "northern", .(lat_N1 = lat, lat_N2 = lat + dLat), by = .(taxon, side, method)][rls_summary[limit == "southern", .(lat_S1 = lat, lat_S2 = lat + dLat), by = .(taxon, side, method)], on= .(taxon, side, method)][, .(range1 = lat_N1 - lat_S1, range2 = lat_N2 - lat_S2), by = .(taxon, side, method)]

rls_summary_range <- rls_summary_range[, .(dRange = range2 - range1), by = .(taxon, side, method)]

rls_summary <- rls_summary[rls_summary_range, on= .(taxon, side, method)]
```

***
