---
title: "Distinguishing latitudinal changes of shallow reef species over a decade of environmental change in Australia"
author: "Yann Herrera Fuchs"
date: "2023-01-25"
output: 
  html_document:
    theme: darkly
    highlight: default
    toc: true
    toc_depth: 3
    toc_float:
      toc_collapse: true
    code_folding: hide
    fig_width: 10
    fig_height: 7
    fig_caption: true
---

This is the code used for analyzing the data for Chapter 1

Remember to set working directory

# Load initial packages and data {.tabset}

*Packages used* 
```{r Load packages, message=FALSE, warning=FALSE}
rm(list = ls()) # clear environment memory

dir <- "C:/Users/yherrera/OneDrive - University of Tasmania/Desktop/UTas/R"
setwd(dir)

# Data wrangling
library(tidyverse) # for manipulating data in tidy format
library(data.table) # summarizing and subsetting more efficiently using data.table syntax
library(DT) # for online data.table manipulation

# Statistical analysis

# Maps and figures

```

*Input data*
```{r Reading raw data, message=FALSE}
# RLS dataset
rls.raw <- fread(paste0(dir, "/Raw Data/ep_m1_m2_AUS.csv")) #nrows = 1,634,614

# Species traits dataset (for extracting guild information)
traits <- fread(paste0(dir, "/Raw Data/TRAITS MASTER.csv")) #nrows = 5,188

# RLS survey ID sea-surface temperature dataset (Conor's method)
sst_data <- fread(paste0(dir, "/Raw Data/rls_sites_sst2.csv")) #nrows = 54,973
```

***
## Code
### Organizing data

Adjust species naming conventions
```{r}
rls.raw[, taxon:= ifelse(taxon == "Cenolia glebosus",
                         "Tropiometra afra",
                         ifelse(taxon == "Echinostrephus molaris",
                                "Echinostrephus aciculatus",
                                ifelse(taxon == "Fistularia pertimba", "Fistularia commersonii",
                                       ifelse(taxon == "Holothuria nobilis",
                                              "Holothuria whitmaei",
                                              ifelse(taxon == "Saurida nebulosa", "Saurida gacilis",
                                                     taxon)))))]
```


Add guild information from the traits matrix.
```{r}
# Join datasets
rls <- rls.raw[traits[, .(taxon = `CURRENT_SPECIES_NAME`,
                          guild = `thermal guild`)], 
               on= "taxon", nomatch = NULL] # nrow = 1,575,443
```

Add information on SST at each survey. We are using the average of the 2-years daily SST leading to the survey date. This is to account for periods of extreme or anomalous weather events.
```{r}
# Get mean SST at each survey ID
sst_data <- sst_data[, .(mean_sst = mean(mean_sst, na.rm = TRUE)), by = .(survey_id)] # nrow = 28,074

# Select columns of interest from SST data
rls <- rls[sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL]#nrow = 1,575,691

rls <- rls[!is.na(mean_sst)] #nrow = 1,272,381
```

***

### Filtering and processing the data 
#### Removing unnecessary data

Remove data that will not be used in this analysis.
```{r Remove unnecessary data, message=FALSE, warning=FALSE}
# Remove species with .sp and .spp (those which don't have species fully resolved)
rls <- rls[which(grepl("sp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,271,259
rls <- rls[which(grepl("spp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,249,991

# Remove NAs in taxon data
rls <- rls[which(is.na(rls$taxon) == F), ] #nrow = 1,249,991

# Select vertebrate and invertebrate classes to include in analysis
rls <- rls[class %in% c("Asteroidea", "Cephalopoda", "Crinoidea", "Echinoidea", "Gastropoda", "Holothuroidea", "Malacostraca", "Actinopterygii", "Elasmobranchii"), ] #nrow = 1,243,199 
#NOTE: changed Chondrichtyes to Elasmobranchii, Crinoidea and Holothuroidea not found in raw dataset

# Subset to data from 2010 onwards
rls <- rls[year(survey_date) >= "2010"] #nrow = 1,105,661
```

#### Data adjustments
Make sure that there is a unique latitude and longitude value for each site_code.

```{r}
# Calculate mean latitude and longitude values to obtain unique coordinates
rls_sites <- rls[, lapply(.SD, mean), 
                 by = .(site_code),
                 .SDcols = c("latitude", "longitude")]


rls <- rls[, c(1:8, 11:34)][rls_sites, on= .(site_code)] 
```

Adjust method and block data. There should only be two blocks in each transect, and cryptic fish and invertebrates are only found in method 2.
```{r Adjust method and block, message=FALSE, warning=FALSE}
# Remove block 0
rls <- rls[block != 0] #nrow = 1,105,659

# Remove fish species in M2 from M1 (cryptic fish)
rls[method == 1 & taxon %in% rls[method == 2 & class == "Actinopterygii"]$taxon]$method <- 2
    
# Change method 1 inverts to method 2
rls[class != "Actinopterygii" & class != "Elasmobranchii"]$method <- 2
```

The raw data is already tallied by block, so we need to sum abundance data for each species by survey ID to get N per 500m^2^ for M1, and per 50m^2^ for M2 (the total of each unique species on each survey).
```{r Summing abundance data, message=FALSE, warning=FALSE}
rls <- rls[, .(total = sum(total)), 
           by = .(taxon, survey_id,
                  # add factors of interest
                  class, guild, 
                  site_code, latitude, longitude,
                  survey_date, 
                  mean_sst)] #nrow = 457,244
```

#### Site selection and time periods
In order to avoid sampling biases, we focus on analyzing latitudinal change from the first and last years that sites were surveyed using June 2016 as a heatwave cutoff 

```{r}
# Define period
rls <- rls[, period:= ifelse(survey_date < "2016-06-01", # heatwave period
                             "t1", "t2")]
# Select sites
rls <- rls[, ':=' (year_i = min(year(survey_date)),
                   year_f = max(year(survey_date)),
                   dt = max(year(survey_date)) - min(year(survey_date))),
           by = .(site_code)]

rls[, mean(dt)] # average time period: 6.77 years

# Remove data in between those time periods and those sites that were only surveyed once. Also removed sites that were not found in both periods
rls <- rls[year(survey_date) == year_i | year(survey_date) == year_f] #nrow = 273,508
rls <- rls[dt > 0] #nrow = 205,153
rls <- rls[site_code %in% rls[period == "t1"]$site_code & site_code %in% rls[period == "t2"]$site_code] #nrow = 178,124
```

#### Further filtering

To reduce noise we set taxon-level filters.

```{r}
# Discard species occurring in less than 30 sites.
species_list <- rls[, .(site_code = unique(site_code)), by = .(taxon)][, .(N_site = .N), by = .(taxon)]
rls <- rls[species_list, on= .(taxon)][N_site >= 30] # nrow = 164,603

# Categorize rare and common species based on whether they appear in less than 80 sites in the first time period
rls <- rls[, presence:= ifelse(N_site < 80, "rare", "common"), 
                    by = .(taxon)]
```

We also have to calculate the average abundance of species per site per period, and average temperature data the same way.
```{r Site-specific temperature and abundance data per year, message=TRUE, warning=FALSE}
# Density (abundance per site), temperature and site calculations by year
rls <- rls[, lapply(.SD, mean), # calculate means for the specified data cols
           by = .(taxon, site_code, period,
                  # include factors of interest
                  class, 
                  guild, presence, 
                  latitude, longitude,
                  year_i, year_f, dt,
                  N_site), # subsets
           .SDcols = c("total", "mean_sst")] # data cols to average
# nrow = 101,044
```

### Calculating distribution limits

##### Skew values, 5th and 95th percentiles

To compare parameter values to changes in abundance, we calculate the midway point (skew), 5th and 95th percentiles of cumulative site abundance for each species at each period. Then we extract the latitude associated to these values to assess the change before and after the heatwave.

```{r}
# Set sides
rls <- rls[, side:= ifelse(longitude < 147, "west", "east")]

# Order "rls" dataset from north to south for each species
rls <- rls[order(taxon, -latitude)]
```

###### Northern limits of tropical species
These limits are combined given the geography of tropical Australia
```{r}
## Northern limits tropical species
# Calculate cumulative sum of site abundance by species at each period
rls_trop <- rls[guild == "tropical"]

rls_trop[, ':=' (cum_abun = cumsum(total)),
         by = .(taxon, period)]

# Calculate 5th percentile (N limit)
rls_trop[, ':=' (abun_5 = round(max(cum_abun) * 0.05)), 
         by = .(taxon, period)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_trop <- rls_trop[, .(min_dif = abs(abun_5 - cum_abun), 
                           cum_abun, abun_5, 
                           Lat05 = latitude,
                           Lon05 = longitude,
                           site05 = site_code,
                           Temp05 = mean_sst), 
                       by = .(taxon, period)][order(taxon, period, min_dif)][, .SD[1], by = .(taxon, period)]

# Join to main rls subset
rls_trop <- rls_trop[Lat05_trop[, .(taxon, period, Lat05, Lon05, site05, Temp05)], on= .(taxon, period)]
```

###### Optimum and southern limits of tropical species
```{r}
## Tropical species optimum and southern 
rls_trop[, cum_abun:= cumsum(total),,
         by = .(taxon, period, side)]

# Calculate midway point and 95th percentiles
rls_trop[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                 abun_95 = round(max(cum_abun) * 0.95)), 
         by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_trop <- rls_trop[, .(min_dif = abs(abun_mid - cum_abun), 
                             cum_abun, abun_mid, 
                             Latskew = latitude,
                             Lonskew = longitude,
                             siteskew = site_code,
                             Tempskew = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_trop <- rls_trop[, .(min_dif = abs(abun_95 - cum_abun), 
                           cum_abun, abun_95, 
                           Lat95 = latitude,
                           Lon95 = longitude,
                           site95 = site_code,
                           Temp95 = mean_sst), 
                       by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_trop <- rls_trop[Latskew_trop[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]
rls_trop <- rls_trop[Lat95_trop[, .(taxon, period, side, Lat95, Lon95, site95, Temp95)], on= .(taxon, period, side)]
```

###### Temperate species occuring on only one side
```{r}
## Temperate species
# Species occuring only on one side
# Calculate cumulative sum of site abundance by species at each period and side
# Temperate species have combined east and west lower limits (only if they occur on both sides)
# List temperate species which are found on only one side
temp_1side <- rls[guild == "temperate", .(taxon = unique(taxon)), by = .(side)][, .N, by = .(taxon)][order(N)][N < 2]

rls_temp1 <- rls[taxon %in% temp_1side$taxon]

rls_temp1[, cum_abun:= cumsum(total),
          by = .(taxon, period, side)]

# Calculate midway point, 5th and 95th percentiles
rls_temp1[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                  abun_5 = round(max(cum_abun) * 0.05),
                  abun_95 = round(max(cum_abun) * 0.95)), 
          by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_temp1 <- rls_temp1[, .(min_dif = abs(abun_mid - cum_abun), 
                               cum_abun, abun_mid, 
                               Latskew = latitude,
                               Lonskew = longitude,
                               siteskew = site_code,
                               Tempskew = mean_sst), 
                           by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Latskew_temp1[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_temp1 <- rls_temp1[, .(min_dif = abs(abun_5 - cum_abun), 
                             cum_abun, abun_5, 
                             Lat05 = latitude,
                             Lon05 = longitude,
                             site05 = site_code,
                             Temp05 = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Lat05_temp1[, .(taxon, period, side, Lat05, Lon05, site05, Temp05)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_temp1 <- rls_temp1[, .(min_dif = abs(abun_95 - cum_abun), 
                             cum_abun, abun_95, 
                             Lat95 = latitude,
                             Lon95 = longitude,
                             site95 = site_code,
                             Temp95 = mean_sst), 
                         by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp1 <- rls_temp1[Lat95_temp1[, .(taxon, period, side, Lat95, Lon95, site95, Temp95)], on= .(taxon, period, side)]
```

###### Temperate species occuring on both sides
```{r}
# Species occuring on both sides
# Calculate cumulative sum of site abundance by species at each period and side
# List temperate species which are found on both sides
temp_2side <- rls[guild == "temperate", .(taxon = unique(taxon)), by = .(side)][, .N, by = .(taxon)][order(N)][N == 2]

rls_temp2_NO <- rls[taxon %in% temp_2side$taxon]

rls_temp2_NO[, cum_abun:= cumsum(total),
          by = .(taxon, period, side)]

# Calculate midway point and 5th percentiles
rls_temp2_NO[, ':=' (abun_mid = round(max(cum_abun) * 0.5),
                     abun_5 = round(max(cum_abun) * 0.05)), 
             by = .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew_temp2 <- rls_temp2_NO[, .(min_dif = abs(abun_mid - cum_abun), 
                                  cum_abun, abun_mid, 
                                  Latskew = latitude,
                                  Lonskew = longitude,
                                  siteskew = site_code,
                                  Tempskew = mean_sst), 
                              by = .(taxon, period, side)][order(taxon, period, side,  min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp2 <- rls_temp2_NO[Latskew_temp2[, .(taxon, period, side, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, side)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05_temp2 <- rls_temp2_NO[, .(min_dif = abs(abun_5 - cum_abun), 
                                cum_abun, abun_5, 
                                Lat05 = latitude,
                                Lon05 = longitude,
                                site05 = site_code,
                                Temp05 = mean_sst), 
                            by = .(taxon, period, side)][order(taxon, period, side, min_dif)][, .SD[1], by = .(taxon, period, side)]

# Join to main rls subset
rls_temp2 <- rls_temp2[Lat05_temp2[, .(taxon, period, side, Lat05, Lon05, site05, Temp05)], on= .(taxon, period, side)]

# The southern limits for these species are combined
rls_temp2_S <- rls[taxon %in% temp_2side$taxon]

rls_temp2_S[, cum_abun:= cumsum(total),
            by = .(taxon, period)]

# Calculate midway point, 5th and 95th percentiles
rls_temp2_S[, ':=' (abun_95 = round(max(cum_abun) * 0.95)), 
            by = .(taxon, period)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95_temp2 <- rls_temp2_S[, .(min_dif = abs(abun_95 - cum_abun), 
                               cum_abun, abun_95, 
                               Lat95 = latitude,
                               Lon95 = longitude,
                               site95 = site_code,
                               Temp95 = mean_sst), 
                           by = .(taxon, period)][order(taxon, period, min_dif)][, .SD[1], by = .(taxon, period)]

# Join to main rls subset
rls_temp2 <- rls_temp2[Lat95_temp2[, .(taxon, period, abun_95, Lat95, Lon95, site95, Temp95)], on= .(taxon, period)]
```

###### Join subsets
```{r}
# Gather all subsets
rls <- rbind(rls_trop, rls_temp1, rls_temp2) #nrow = 101,044
```

### Producing a working dataset

#### Restructure dataset 
```{r}
## Order by limit and category
# Abundance weighted quantiles
rls_trop_N_wt <- rls[guild == "tropical", 
                     .(taxon, class, guild, presence, 
                       site_code, latitude, longitude, N_site,
                       period, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat05,
                       lat_abun = abun_5,
                       lon = Lon05,
                       site = site05,
                       temp = Temp05,
                       limit = "northern",
                       side = "both")]
rls_temp_N_wt <- rls[guild == "temperate", 
                     .(taxon, class, guild, presence, 
                       site_code, latitude, longitude, N_site,
                       period, side, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat05,
                       lat_abun = abun_5,
                       lon = Lon05,
                       site = site05,
                       temp = Temp05,
                       limit = "northern")]

rls_S_wt <- rls[guild == "tropical" | taxon %in% temp_1side$taxon, 
                .(taxon, class, guild, presence,
                  site_code, latitude, longitude, N_site,
                  period, side, year_i, year_f, dt,
                  total, mean_sst, 
                  lat = Lat95,
                  lat_abun = abun_95,
                  lon = Lon95,
                  site = site95,
                  temp = Temp95,
                  limit = "southern")]
rls_temp_S_wt <- rls[taxon %in% temp_2side$taxon, 
                     .(taxon, class, guild, presence,
                       site_code, latitude, longitude, N_site,
                       period, year_i, year_f, dt,
                       total, mean_sst, 
                       lat = Lat95,
                       lat_abun = abun_95,
                       lon = Lon95,
                       site = site95,
                       temp = Temp95,
                       limit = "southern",
                       side = "both")]

rls <- rbind(rls_trop_N_wt, rls_temp_N_wt, rls_S_wt, rls_temp_S_wt) #nrow = 202,088
```


#### Calculate changes in periods
```{r}
### Calculate latitudinal changes for each species' limits, dispersion index and population trends
rls_summary_t1 <- rls[period == "t1", 
                      .(lat1 = unique(lat), lon1 = unique(lon), site1 = unique(site), 
                        temp1 = unique(temp), 
                        total_log1 = log(unique(lat_abun)) + 1),
                      by = .(taxon, limit,
                             side,
                             # include factors of interest
                             class, guild, presence, 
                             N_site)] # nrow = 1,968


rls_summary_t2 <- rls[period == "t2", 
                      .(lat2 = unique(lat), lon2 = unique(lon), site2 = unique(site), 
                        temp2 = unique(temp), 
                        total_log2 = log(unique(lat_abun)) + 1),
                      by = .(taxon, limit,
                             side,
                             #include factors of interest
                             class, guild, presence, 
                             N_site)] # nrow = 2,098

rls_summary <- rls_summary_t1[rls_summary_t2, on = .(taxon, 
                                                     side,
                                                     class, guild, presence, limit)] #nrow = 1,950

rls_summary <- rls_summary[, ':=' (dLat = lat2 - lat1,
                                   dLon = lon2 - lon1,
                                   dTemp = temp2 - temp1,
                                   pop_trend = total_log2 - total_log1)]

rls_summary <- rls_summary[!is.na(dLat)] #nrow = 1,931

# Organize dataset
rls_summary <- rls_summary[, .(taxon, class, 
                               guild, limit, 
                               side,
                               lat1, lat2, dLat,
                               lon1, lon2, dLon,
                               site1, site2, N_site,
                               temp1, temp2, dTemp,
                               total_log1, total_log2, pop_trend,
                               presence)]
```

#### Add traits of interest
```{r}
# Rename and join traits of interest
rls_summary <- rls_summary[traits[, .(taxon = `CURRENT_SPECIES_NAME`,
                                      range = `Range`,
                                      trophic_level = `Trophic Level`,
                                      trophic_group = `Trophic group2`,
                                      max_length = `MaxLength`,
                                      water_column = `Water column`,
                                      habitat = `Habitat`,
                                      max_depth = `Max depth`,
                                      therm_max = `Thermal_95thmax`,
                                      therm_mid = `ThermalMP_5_95`,
                                      sgi = `SGI`)], on = .(taxon), nomatch = NULL]
```


#### Add bioregions based on latitude and longitude extremes
```{r}
rls_summary <- rls_summary[, region:= ifelse(lat1 > -23, "NA",
                                             ifelse(lat1 < -23 & lon1 < 120, "WA",
                                                    ifelse(lat1 %between% c(-40, -30) & lon1 %between% c(120, 147), "SA",
                                                           ifelse(lat1 %between% c(-40, -23) & lon1 > 147, "SE", 
                                                                  ifelse(lat1 > -23 & lon1 > 147, "NA", "TAS"))))),
                           by = .(taxon, limit)]
```

#### Add dSST data
```{r}
# Merge site data and SST by survey_id
rls_sites <- rls.raw[site_code %in% c(rls_summary$site1, rls_summary$site2)][, .(site_code, latitude, longitude), by = .(survey_id, survey_date)][sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL] #nrow = 967,347

rls_sites <- rls_sites[!is.na(mean_sst)] #nrow = 888,389

# Linear regression to obtain mean SST change
rls_sites <- rls_sites[, .(sst_lm = list(lm(mean_sst ~ year(survey_date))),
                           year_i = min(year(survey_date)),
                           year_f = max(year(survey_date)),
                           latitude = mean(latitude),
                           longitude = mean(longitude)),
                       by = .(site_code)]

# Extract sst_t1 and sst_t2
rls_sites <- rls_sites[, ':=' (sst_t1 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year(survey_date)"] * year_i,
                               sst_t2 = sst_lm[[1]]$coefficients["(Intercept)"] + sst_lm[[1]]$coefficients["year(survey_date)"] * year_f),
                       by = .(site_code)]

# Calculate dSST
rls_sites <- rls_sites[, dSST:= sst_t2 - sst_t1]

# Add dSST data
rls_summary <- rls_summary[rls_sites[, .(latitude, longitude, dSST), by = .(site1 = site_code)], on= .(site1),
                           nomatch = NULL] #nrow = 1,931
```


#### Remove dodgy limits/species errors and save dataset
```{r}
# Remove species that are errors
errors <- c("Atypichthys strigatus", "Cheilodipterus quinquelineatus", "Chelmonops truncatus", "Chromis nitida", "Cirripectes castaneus", "Cirripectes chelomatus", "Cirripectes filamentosus", "Cirripectes hutchinsi", "Cirripectes stigmaticus", "Comanthus tasmaniae", "Dotalabrus aurantiacus", "Echinostrephus aciculatus", "Enneapterygius atrogulare", "Enneapterygius rufopileus", "Enneapterygius similis", "Eocallionymus papilio", "Fusigobius duospilus", "Fusigobius neophytus", "Gnatholepis anjerensis", "Gnatholepis cauerensis", "Gobiodon quinquestrigatus", "Halichoeres erdmanni", "Holothuria whitmaei", "Istigobius rigilius", "Parapercis pacifica", "Parapercis queenslandica", "Pteraeolidia ianthina", "Thalassoma purpureum", "Tropiometra afra", "Orectolobus halei", "Oxycomanthus bennetti")

rls_summary <- rls_summary[!which(taxon %in% errors)] #nrow = 1,861

# Save dataset for corrections and checking of species limits
write.csv(rls_summary[order(taxon)], paste0(dir, "/chapter1/rls_summary.csv"), row.names = FALSE)
```


#### Statistical analysis
```{r}
# Statistical significance
#t.test(rls_summary[abs(dLat) < 5 & guild == "tropical" & limit == #"northern"]$dLat, mu = 0) # p < 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "southern" & guild == #"tropical" & side == "west"]$dLat, mu = 0) # p < 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "northern" & guild == #"temperate" & side == "west"]$dLat, mu = 0) # p = 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "northern" & guild == #"temperate" & side == "east"]$dLat, mu = 0) # p < 0.05

#rls_summary[abs(dLat) < 5 & limit != "optimum", t.test(dLat, mu = 0), by = .(guild, side, limit)][p.value < 0.05]



#fit <- aov(dLat ~ 1 + guild + limit + side, data = rls_summary)

#library(multcomp)

#summary(glht(fit, linfct = mcp(guild = "Dunnett")))
```


#### Plots
```{r}
# Remove unnecessary datasets
rm(Lat05_temp1,
   Lat05_temp2,
   Lat05_trop,
   Lat95_temp1,
   Lat95_temp2,
   Lat95_trop,
   Latskew_temp1,
   Latskew_temp2,
   Latskew_trop,
   rls_S_wt,
   rls_summary_t1,
   rls_summary_t2,
   rls_temp_N_wt,
   rls_temp_S_wt,
   rls_temp1,
   rls_temp2,
   rls_temp2_NO,
   rls_temp2_S,
   rls_trop,
   rls_trop_N_wt,
   species_list,
   temp_1side,
   temp_2side)

# Create factors
rls_summary <- rls_summary[, ':=' (guild = factor(guild, levels = c("tropical", "temperate")),
                                   class = factor(ifelse(class %in% c("Actinopterygii", "Elasmobranchii"), "fish", "invertebrate"), levels = c("fish", "invertebrate")),
                                   presence = factor(presence, levels = c("common", "rare")),
                                   water_column = factor(water_column),
                                   trophic_group = factor(trophic_group),
                                   habitat = factor(ifelse(habitat == "Coral", "coral",
                                                           ifelse(habitat == "Sand", "sand", habitat)), levels = c("coral", "rock", "sand", "water column")),
                                   region = factor(region, levels = c("NA", "WA", "SA", "SE", "TAS")),
                                   limit = factor(limit, levels = c("northern", "southern")))]
```

##### Summary Plots
```{r}
## Main data distribution
rls_summary_bp <- ggplot(rls_summary, aes(x = class, y = dLat, col = guild)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "Changes in latitudinal limits (° latitude)", subtitle = "a") +
  theme_bw() +
  guides(colour = "none")

# Averages
rls_means_wt <- rls_summary[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                              dTemp_mean = mean(dTemp),
                              dTemp_sd = sd(dTemp),
                              dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                            by = .(limit, guild, class)]

rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = class, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "Mean changes in latitudinal limits (° latitude)", subtitle = "b") +
  theme_bw() +
  guides(colour = "none")

library(ggpubr)

ggarrange(rls_summary_bp, rls_means_plot_wt,
          nrow = 2, ncol = 1)
```

##### Species wallpaper
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Species wallpapers
taxon_list <- rls_summary[limit != "optimum"][order(-abs(dLat))][, .SD[1:50]]$taxon

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

ggplot() +
  # Rasters
  geom_sf(data = aus_sf) +
  
  # sites included in analysis
  geom_point(data = rls[limit != "optimum"][taxon %in% taxon_list], 
             aes(x = longitude, y = latitude, shape = side),
             size = 3) +
  
  # Select shapes to display
  scale_shape_manual(values = c("east" = 1, "west" = 2)) +
  
  # Limit lines
  geom_hline(data = rls[limit != "optimum"][taxon %in% taxon_list],
             aes(yintercept = lat, col = limit, lty = side)) +
  
  # East/west division
  geom_vline(xintercept = 142.5, lty = "dashed") +
  annotate("text", x = 150, y = -7, label = "east") +
  annotate("text", x = 132, y = -7, label = "west") +
  
  # Facet by taxon
  facet_wrap(vars(taxon, period)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  theme_bw()
```


##### Regional map with means
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_sites_sf <- st_as_sf(rls_summary, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")

# Plot
aus_map <- ggplot() +
  
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) + # dSST
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # sites included in analysis
  geom_point(data = rls_summary, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-1.45, 1.80, 0.65),
                       limits = c(-1.45, 1.80)) +
  
  # regional divisions
  geom_segment(aes(x = 114, y = -23, xend = 110, yend = -23), linewidth = 2) +
  geom_spoke(aes(x = 120, y = -34), angle = -90, radius = 11, linewidth = 2) +
  geom_segment(aes(x = 150, y = -23, xend = 160, yend = -23), linewidth = 2) +
  geom_curve(aes(x = 143, y = -44, xend = 150, yend = -44), curvature = -1.4, angle = 95, linewidth = 2) +
  
  # labels
  geom_text(aes(x = 115, y = -10, label = "a"), fontface = "bold") +
  geom_text(aes(x = 111, y = -32, label = "b"), fontface = "bold") +
  geom_text(aes(x = 130, y = -36, label = "c"), fontface = "bold") +
  geom_text(aes(x = 157, y = -35, label = "d"), fontface = "bold") +
  geom_text(aes(x = 140, y = -43, label = "e"), fontface = "bold") +
  
  # adjust axes labels
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dSST (°C)", x = NULL, y = NULL) +
  theme_bw() +
  theme(legend.position = "bottom", legend.direction = "horizontal") 

# Regional means
rls_means_region <- rls_summary[, 
                                .(N = NROW(dLat),
                                  dLat_mean = mean(dLat),
                                  dLat_sd = sd(dLat),
                                  dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                                  dTemp_mean = mean(dTemp),
                                  dTemp_sd = sd(dTemp),
                                  dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                                by = .(limit, guild, region, class)]

rls_means_region_plot <- ggplot(rls_means_region,
                                aes(x = class, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ region) +
  labs(y = "Mean changes in latitudinal limits (° latitude)") +
  theme_bw() +
  guides(colour = "none")

# Set guild color scheme
guild_cols <- c(tropical = "#F8766D",
                temperate = "#00BFC4")

NA_plot <- ggplot(rls_means_region[region == "NA" & N > 10], aes(x = limit, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)),
            size = 4, 
            hjust = 1.3,
            col = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(.~ class) +
  labs(y = "dLat", subtitle = "a", fontface = "bold") +
  guides(colour = "none") +
  theme_bw()

WA_plot <- ggplot(rls_means_region[region == "WA" & N > 10], aes(x = limit, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)), 
            size = 4, 
            hjust = -0.4,
            col = "black") + 
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(.~ class) +
  labs(y = "dLat", subtitle = "b", fontface = "bold") +
  guides(colour = "none") +
  theme_bw()

SA_plot <- ggplot(rls_means_region[region == "SA" & N > 10], aes(x = limit, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)),  
            size = 4, 
            hjust = -0.2,
            col = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(.~ class) +
  labs(y = "dLat", subtitle = "c", fontface = "bold") +
  guides(colour = "none") +
  theme_bw()

SE_plot <- ggplot(rls_means_region[region == "SE" & N > 10], aes(x = limit, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)), 
            size = 4, 
            hjust = -0.3,
            col = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(.~ class) +
  labs(y = "dLat", subtitle = "d", fontface = "bold") +
  guides(colour = "none") +
  theme_bw()

TAS_plot <- ggplot(rls_means_region[region == "TAS" & N > 10], aes(x = limit, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = guild_cols) + 
  geom_text(aes(label = paste("N =", N)), 
            size = 4, 
            hjust = -0.2,
            col = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(.~ class) +
  labs(y = "dLat", subtitle = "e", fontface = "bold") +
  guides(col = "none") +
  theme_bw()

library(cowplot)

plot_grid(
  plot_grid(NULL, WA_plot, SA_plot, ncol = 1),
  plot_grid(NA_plot, NULL, aus_map, ncol = 1, rel_heights = c(1, 0, 2)),
  plot_grid(NULL, SE_plot, TAS_plot, ncol = 1),
  ncol = 3
)

```

##### IDW maps of dLat 
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

# Northern limit
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "northern"][rls_summary[limit == "northern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatN_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.82, 2.2, 0.6),
                       limits = c(-0.82, 2.2)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: N", subtitle = "a") +
  theme_bw()

# Southern
# Average dLat by site and remove those with less than 3 data points
rls_dLat <- rls_summary[limit == "southern"][rls_summary[limit == "southern", .(dLat), by = .(site1, longitude, latitude)][, .N, by = .(site1)], on = .(site1)][N > 2][, .(dLat = mean(dLat)), by = .(site1, longitude, latitude)]

# Simple features object
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatS_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-3.3, 4.1, 1.48),
                       limits = c(-3.3, 4.1)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dLat: S", subtitle = "b") +
  theme_bw()


# CTI maps
rls_cti <- rls[taxon %in% rls_summary$taxon & site_code %in% rls_sites$site_code][traits[, .(thermal_mid = `ThermalMP_5_95`), by = .(taxon = `CURRENT_SPECIES_NAME`)], on = .(taxon), nomatch = NULL]

rls_cti <- rls_cti[, .(taxon = unique(taxon)), by = .(site_code, latitude, longitude, period, thermal_mid)]

rls_cti <- rls_cti[period == "t1", .(cti_t1 = mean(thermal_mid, na.rm = T)), by = .(site_code, latitude, longitude)][rls_cti[period == "t2", .(cti_t2 = mean(thermal_mid, na.rm = T)), by = .(site_code, latitude, longitude)], on = .(site_code, latitude, longitude)]

rls_cti[, dCTI:= cti_t2 - cti_t1]

rls_cti <- rls_cti[!is.na(dCTI)]

rls_cti <- rls_cti[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

rls_cti <- rls_cti[, region:= ifelse(latitude > -23, "NA",
                                             ifelse(latitude < -23 & longitude < 120, "WA",
                                                    ifelse(latitude %between% c(-40, -30) & longitude %between% c(120, 147), "SA",
                                                           ifelse(latitude %between% c(-40, -23) & longitude > 147, "SE", 
                                                                  ifelse(latitude > -23 & longitude > 147, "NA", "TAS"))))),
                           by = .(site_code)]

# Create simple features objects and a spatial grid for interpolation
rls_dCTI <- rls_cti[, .(longitude, latitude, dCTI)]
rls_dCTI_sf <- st_as_sf(rls_dCTI, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dCTI ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dCTI_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dCTI")

# Plot
dCTI_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dCTI)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.6, 0.6, 0.24),
                       limits = c(-0.6, 0.6)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dCTI", subtitle = "c") +
  theme_bw()


# CTI maps
rls_cgi <- rls[taxon %in% rls_summary$taxon & site_code %in% rls_sites$site_code][traits[, .(sgi = `SGI`), by = .(taxon = `CURRENT_SPECIES_NAME`)], on = .(taxon), nomatch = NULL]

rls_cgi <- rls_cgi[, .(taxon = unique(taxon)), by = .(site_code, latitude, longitude, period, sgi)]

rls_cgi <- rls_cgi[period == "t1", .(cgi_t1 = mean(sgi, na.rm = T)), by = .(site_code, latitude, longitude)][rls_cgi[period == "t2", .(cgi_t2 = mean(sgi, na.rm = T)), by = .(site_code, latitude, longitude)], on = .(site_code, latitude, longitude)]

rls_cgi[, dCGI:= cgi_t2 - cgi_t1]

rls_cgi <- rls_cgi[!is.na(dCGI)]

rls_cgi <- rls_cgi[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

rls_cgi <- rls_cgi[, region:= ifelse(latitude > -23, "NA",
                                             ifelse(latitude < -23 & longitude < 120, "WA",
                                                    ifelse(latitude %between% c(-40, -30) & longitude %between% c(120, 147), "SA",
                                                           ifelse(latitude %between% c(-40, -23) & longitude > 147, "SE", 
                                                                  ifelse(latitude > -23 & longitude > 147, "NA", "TAS"))))),
                           by = .(site_code)]

# Create simple features objects and a spatial grid for interpolation
rls_dCGI <- rls_cgi[, .(longitude, latitude, dCGI)][!is.na(dCGI)]
rls_dCGI_sf <- st_as_sf(rls_dCGI, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
    cellsize = c(1, 1), # 1 degree cell size
    what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dCGI ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dCGI_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dCGI")

# Plot
dCGI_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dCGI)) +
  geom_sf(data = st_union(aus_sf)) + # Continent polygon
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-3, 3, 1.2),
                       limits = c(-3, 3)) +
  
  scale_x_continuous(breaks = seq(110, 160, by = 10), limits = c(110, 160), label = paste0(seq(110, 160, by = 10), "°E")) +
  scale_y_continuous(breaks = seq(-40, -10, by = 5), limits = c(-44, -7), label = paste0(seq(-40, -10, by = 5), "°S")) +
  labs(fill = "dCGI", subtitle = "d") +
  theme_bw()


# Collate all maps
ggarrange(dLatN_plot, dCTI_plot,
          dLatS_plot, dCGI_plot,
          nrow = 2, ncol = 2)
```


##### dSST regression plots
```{r}
# Select the 10 northernmost sites for each species' limits
ext_sites_N <- rls[, .(site_code = unique(site_code)), by = .(latitude, taxon, period)][order(taxon, period, -latitude)][, .SD[1:10], by = .(taxon, period)]

# Add dSST data
ext_sites_N <- ext_sites_N[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

# Calculate mean dSST for all extreme sites for each species
ext_sites_N <- ext_sites_N[, .(dSST = mean(dSST)), by = .(taxon, period)]

# Add dLat values
ext_sites_N <- ext_sites_N[rls_summary[limit == "northern", .(dLat, region, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi), by = .(taxon)], on = .(taxon)]

# Select the 10 southernmost sites for each species' limits
ext_sites_S <- rls[, .(site_code = unique(site_code)), by = .(latitude, taxon, period)][order(taxon, period, latitude)][, .SD[1:10], by = .(taxon, period)]

# Add dSST data
ext_sites_S <- ext_sites_S[rls_sites[, .(dSST), by = .(site_code)], on = .(site_code)]

# Calculate mean dSST for all extreme sites for each species
ext_sites_S <- ext_sites_S[, .(dSST = mean(dSST)), by = .(taxon, period)]

# Add dLat values
ext_sites_S <- ext_sites_S[rls_summary[limit == "southern", .(dLat, region, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi), by = .(taxon)], on = .(taxon)]

ext_sites_N <- ext_sites_N[, .(taxon, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi, region, dLat, dSST, limit = "northern")]

ext_sites_S <- ext_sites_S[, .(taxon, guild, class, pop_trend, presence, range, trophic_level, trophic_group, max_length, water_column, habitat, therm_max, therm_mid, sgi, region, dLat, dSST, limit = "southern")]

ext_sites <- rbind(ext_sites_N, ext_sites_S)

# dLat vs dSST regression
dLat_dSST_plot <- ggplot(ext_sites,
                         aes(x = dSST, y = dLat)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(region ~ guild + limit, scales = "free") +
  labs(title = "") +
  theme_bw()

# Subsets showing expected dLat ~ dSST relationships are:
# NA trop N
# (WA trop S)
# WA temp N
# SA temp N
# SA temp S
# SE temp S
# (TAS temp S)

# GAM model to test traits
library(mgcv)

# Note gam/glm might not run with NAs (pop_trend, trophic_level & SGI)
gam(dLat ~ dSST + pop_trend + presence + range + trophic_level + trophic_group + (log(max_length) + 1) + water_column + habitat + therm_max + therm_mid + sgi,
    data = ext_sites[region == "NA" & limit == "northern" & guild == "tropical" | region == "WA" & limit == "northern" & guild == "temperate" | region == "SA" & limit == "northern" & guild == "temperate" | region == "SA" & limit == "southern" & guild == "temperate" | region == "SE" & limit == "southern" & guild == "temperate" | region == "WA" & limit == "southern" & guild == "tropical" | region == "TAS" & limit == "southern" & guild == "temperate"])

# Factors of interest with dSST:
# region | presence | trophic group

NA_reg <- ggplot(ext_sites[region == "NA" & limit == "northern" & guild == "tropical" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "NA northern limits") +
  guides(col = "none") +
  theme_bw()

WA_reg <- ggplot(ext_sites[region == "WA" & limit == "northern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "WA northern limits") +
  guides(col = "none") +
  theme_bw()

SA_reg <- ggplot(ext_sites[region == "SA" & limit == "southern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "SA southern limits") +
  guides(col = "none") +
  theme_bw()

TAS_reg <- ggplot(ext_sites[region == "TAS" & limit == "southern" & guild == "temperate" & trophic_group %in% c("Benthic invertivore", "Herbivore")], aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  scale_color_manual(values = guild_cols) + 
  facet_grid(.~ trophic_group, scales = "free") +
  labs(title = "TAS southern limits") +
  guides(col = "none") +
  theme_bw()

ggarrange(
  ggarrange(NA_reg,
            WA_reg,
            nrow = 2, ncol = 1),
  ggarrange(SA_reg,
            TAS_reg,
            nrow = 2, ncol = 1),
  nrow = 1, ncol = 2)

rls_summary_wide <-  rls_summary[limit == "northern", .(latN = lat1), by = .(taxon)][rls_summary[limit == "southern", .(latS = lat1), by = .(taxon)], on = .(taxon)]
```

##### Traits investigation
```{r}
# General traits investigation
variables <- names(rls_summary[, c(8, 21:31)])[-1]

# Create individual scatterplots
plots <- lapply(variables, function(var) {
    ggplot(rls_summary, aes_string(x = var, y = "dLat")) +
        geom_point() + facet_grid(limit ~.) +
        ggtitle(paste("Scatterplot of dLat vs", var))
})

# Display the scatterplots
ggarrange(plotlist = plots, cols = 3)  # Adjust the number of columns as needed

# Trophic level 
ggplot(rls_summary[, .(dLat = mean(dLat)), by = .(trophic_level, limit, guild)],
       aes(x = trophic_level, y = dLat)) +
    geom_point() +
    geom_smooth(method = 'glm', color = "black") +
    geom_hline(yintercept = 0, lty = "dashed") +
    facet_grid(limit ~ guild) +
    labs(title = "") +
    theme_bw()

# range | trophic level | max_length | max depth | therm mid | therm max
# all display normal distribution, peaks at mid range

gam(abs(dLat) ~ dSST + range + trophic_level + (log(max_length) + 1) + (log(max_depth) + 1) + therm_max + therm_mid,
    data = rls_summary)
# Model suggests range, therm_mid and therm_max are the strongest influencers

# What about all traits?
library(mgcv)

# Fit the GAM model
model <- gam(abs(dLat) ~ range + trophic_level + trophic_group + (log(max_length) + 1) + (log(max_depth) + 1) + water_column + habitat + therm_max + therm_mid + sgi, 
             data = rls_summary)

# Extract the coefficient values and variable names from the model
coefficients <- coef(model)
variable_names <- names(coefficients)
standard_errors <- summary.gam(model)$p.table[, "Std. Error"]
p_values <- summary.gam(model)$p.table[, "Pr(>|t|)"]

# Create a data.table with the coefficient, variable name, and standard error values
trait_dt <- data.table(trait = variable_names, coef = coefficients, std_err = standard_errors, p_val = p_values)

# Order the data.table by the coefficient values in descending order
trait_dt <- trait_dt[2:18][order(-coef)]

# Set traits as factors
trait_dt$trait <- factor(trait_dt$trait, levels = c(trait_dt$trait))

# Plot
ggplot(trait_dt, aes(x = coef, y = trait, col = ifelse(p_val < 0.01, "Significant", "Not Significant"))) +
  geom_point() +
  geom_errorbar(aes(xmin = coef - std_err, xmax = coef + std_err),
                width = 0.2, position = position_dodge(width = 0.3)) +
  scale_y_discrete(limits = rev(levels(trait_dt$trait))) + # Reverse the order of the y-axis
  labs(x = "Coefficient", y = "Trait") +
  scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) +
  geom_vline(xintercept = 0, lty = "dashed") +
  theme_bw() +
  theme(legend.position = "none")



ggplot(data.table(names(coef(model)), coef(model), ), aes( x = V2, y = factor(V1))) + geom_point() +
   geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
```



##### Temperate investigation
```{r}
# Create subset for temperate species
rls_temp <- rls.raw[, location:= ifelse(location == "Port Stephens - North", "Port Stephens", location)] # Combine Port Stephen locations

rls_temp <- rls_temp[taxon %in% rls_summary[presence == "common"]$taxon & location %in% c("Port Stephens", "Solitary Islands", "Maria Island", "D'Entrecasteaux & Derwent") & year(survey_date) >= 2010, .(total = sum(total)), 
                     by = .(taxon, year(survey_date), location)]

# Add traits
rls_temp <- rls_temp[traits[, .(taxon, therm_mid)], on = .(taxon), nomatch = NULL]
rls_temp[, guild:= ifelse(therm_mid > 23, "tropical",
                          ifelse(therm_mid %between% c(17, 23), "temperate warm", "temperate cold"))][!is.na(guild)]


# Convert to wide format to produce presence/absence data
rls_temp <- dcast(rls_temp, taxon + location + guild ~ year, fun.aggregate = function(x) length(x), value.var = "total") # NROW or length

#Convert to long format for manipulation
rls_temp <- melt(rls_temp, id.vars = c("taxon", "location", "guild"),
                 variable.name = "year",
                 value.name = "presence")

# Count number of species by location and year
rls_temp <- rls_temp[rls_temp[, .(N = sum(presence)), by = .(year, location, guild)], on = .(year, location, guild)][rls_temp[presence == 0, .(N_abs = NROW(taxon)), by = .(year, location, guild)], on = .(year, location, guild)]
rls_temp <- rls_temp[, year:= as.numeric(levels(year))[year]] #change factors to numeric

# Define first and last year surveyed for each location
rls_temp <- rls_temp[rls_temp[N > 0, .(year_t1 = min(year),
                      year_t2 = max(year)),
         by = .(location)], on = .(location)]

# Obtain initial, final and total number of species
rls_temp <- rls_temp[year == year_t1, .(N_t1 = unique(N)),
                     by = .(location, guild)][rls_temp, on = .(location, guild)]
rls_temp <- rls_temp[year == year_t2, .(N_t2 = unique(N)),
                     by = .(location, guild)][rls_temp, on = .(location, guild)]
rls_temp <- rls_temp[, .(Nmax = NROW(unique(taxon))),
         by = .(location, guild)][rls_temp, on = .(location, guild)]

# Calculate percentage change throughout time
#rls_temp <- rls_temp[year %between% c(2011, 2021) & N > 0]

rls_temp_t1 <- rls_temp[, 
                             .(taxon, location, guild,
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - N_t1) / N_t1 * 100,
                               compare_point = "t1")]

rls_temp_t2 <- rls_temp[, 
                             .(taxon, location, guild, 
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - N_t2) / N_t2 * 100,
                               compare_point = "t2")]
rls_temp_Nmax <- rls_temp[, 
                             .(taxon, location, guild,
                               year, year_t1, year_t2,
                               N, N_t1, N_t2, Nmax,
                               pct_change = (N - Nmax) / Nmax * 100,
                               compare_point = "Nmax")]

rls_temp <- rbind(rls_temp_t1, rls_temp_t2, rls_temp_Nmax)

# Add dSST
rls_tempsites <- rls.raw[location %in% c("Port Stephens", "Solitary Islands", "Maria Island", "D'Entrecasteaux & Derwent")]

rls_tempsites <- rls_tempsites[sst_data, on = .(survey_id)]

rls_tempsites <- rls_tempsites[, .(mean_sst = mean(mean_sst)),
                       by = .(year(survey_date), location)]

rls_temp <- rls_temp[rls_tempsites, on = .(year, location), nomatch = NULL]

rls_temp$guild <- factor(rls_temp$guild, levels = c("tropical", "temperate warm", "temperate cold"))

write.csv(rls_temp, paste0(dir, "/chapter1/temp_timeseries.csv"), row.names = FALSE)

ggplot(rls_temp) +
  geom_line(aes(x = year, y = pct_change, col = guild, lty = compare_point)) +
  facet_wrap(vars(location))

# Create a plot with two y-axes
p1 <- ggplot(rls_temp, aes(x = year)) +
 
  geom_line(aes(y = N, col = guild)) +
  
  # Add temperature data and right y-axis
  #geom_line(aes(y = mean_sst * 10, color = "red", lty = "dashed")) +
  #scale_y_continuous(name = "Temperature", sec.axis = sec_axis(~ ./10, name = "Temperature (°C)")) +
  # Add x-axis label and plot title
  labs(x = "Year") +
  # Customize plot theme
  facet_grid(location ~ compare_point) +
  theme_bw()

p2 <- ggplot(rls_temp, aes(x = year, y = mean_sst, col= "red", lty = "dashed")) +
  geom_line() +
  facet_grid(location ~., scale = "free") +
  labs(x = "Year", y = "Temperature (°C)") +
  theme_bw() +
  guides(lty = "none", col = "none")

library(ggpubr)

ggarrange(p2, p1, 
          nrow = 1, ncol = 2,
          widths = c(1, 2))
```

##### Tropical species investigation
```{r}
# Divide species into native and non native Australian by latitude
rls_trop <- rls_summary[guild == "tropical"]
rls_trop_native <- rls_trop[limit == "northern", .(native = ifelse(lat1 < -15, "aus", "indo")), by = .(taxon)]
rls_trop <- rls_trop[rls_trop_native, on = .(taxon)]

ggplot(rls_trop, aes(x = therm_max, y = abs(dLat), col = native)) +
    geom_point() + 
  geom_smooth(method = 'glm') + 
  facet_grid(limit ~.)

glm(dLat ~ dSST + native + limit + (log(max_length) + 1) + presence + water_column + trophic_group + habitat + therm_max + sgi,
    data = rls_trop)

# Divide species into native and non native Australian by thermal max
rls_trop <- rls_summary[guild == "tropical"]
therm_threshold <- rls_sites[, max(sst_t1)]
rls_trop[, native:= ifelse(therm_mid < therm_threshold, "aus", "indo"), by = .(taxon)]
rls_trop <- rls_trop[!is.na(native)]

ggplot(rls_trop, aes(x = therm_max, y = abs(dLat), col = native)) +
    geom_point() + 
  geom_smooth(method = 'glm') + 
  facet_grid(limit ~.)

glm(dLat ~ dSST + native + limit + (log(max_length) + 1) + presence + water_column + trophic_group + habitat + therm_max + sgi,
    data = rls_trop)
```


##### Community thermal index
```{r}
ggplot(rls_summary, aes(x = therm_mid, y = dLat)) +
  geom_point() +
  geom_smooth() +
  facet_grid(guild ~ region)

glm(dLat ~ dSST + guild + limit + (log(max_length) + 1) + presence + habitat + water_column + trophic_group + max_depth + therm_mid + therm_max + sgi,
   data = rls_summary[region == "NA"])

#NA -> temperate, southern, max_length, habitat, trophic group

ggplot(rls_summary, aes(x = limit, y = dLat, col = guild)) +
  geom_boxplot() +
  facet_grid(region ~ presence)
```



##### Comparing extreme values
```{r}
rls_ext <- fread(paste0(dir, "/chapter1/rls_summary_ext.csv")) #nrows = 1,634,614

rls_summary[, type:= "normal"]
rls_ext[, type:= "extreme"]

rls_ext <- rls_ext[taxon %in% rls_summary$taxon]

rls_summary_both <- rls_summary[, !c(13, 21)][rls_ext[, .(dLat_ext = dLat), by = .(taxon, limit)], on = .(taxon, limit)][, dLat_dif:= dLat_ext - dLat, by = .(taxon, limit)]

rls_summary_comb <- rbind(rls_summary[, !c(13, 21)], rls_ext)
rls_summary_comb <- rls_summary_comb[taxon %in% rls_summary_both[abs(dLat_dif) > 3]$taxon]


rls_summary_comb <- rls_summary_comb[order(-type, limit, -dLat)]
rls_summary_comb$taxon <- factor(rls_summary_comb$taxon, levels = unique(rls_summary_comb$taxon))

ggplot(rls_summary_comb, aes(x = taxon, y = dLat, col = type, shape = guild)) +
  geom_point() +
  facet_grid(limit ~.)

# Averages
rls_means_wt <- rls_summary_comb[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                            by = .(limit, guild, type)]

rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = type, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Average latitudinal displacement of species limits") +
  theme_bw()

```


```{r}
# Exploratory correlations

## Abundance plots
ggplot(rls_summary[limit != "optimum"], 
       aes(x = class, y = pop_trend, col = guild)) +
  geom_boxplot() +
  facet_grid(limit ~ side)

abun_table <- rls_summary[limit != "optimum", 
                          .(N = NROW(pop_trend),
                            pop_trend_mean = mean(pop_trend),
                            pop_trend_sd = sd(pop_trend),
                            pop_trend_se = sd(pop_trend) / sqrt(NROW(pop_trend))),
                          by = .(class, side, limit, guild)]

abun_plot <- ggplot(abun_table,
                         aes(x = class, y = pop_trend_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = pop_trend_mean - pop_trend_se,
                    ymax = pop_trend_mean + pop_trend_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ side) +
  labs(y = "Population trend", title = "Population trend following the 2016 heatwave") +
  theme_bw()


pop_trend_dSST_plot <- ggplot(rls_summary[limit != "optimum"],
                              aes(x = dSST, y = pop_trend, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(guild + class ~ side) +
  labs(labs = "Population trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

lm(
  pop_trend ~ 1 + dSST, data = rls_sites[, .(dSST), by = .(site = site_code)][rls_summary, on = .(site)][!is.na(dSST)][abs(pop_trend) != Inf][guild == "tropical"] 
)

## Thermal niche and SGIs

# Read thermal niche and SGI data
thermal_niche <- fread(paste0(dir, "/Raw Data/Thermal niche.csv")) #nrows = 4,465
sgi_dt <- fread(paste0(dir, "/Raw Data/SGIs.csv")) #nrows = 26,904

rls_summary_thermal <- thermal_niche[, .(taxon = `SPECIES_NAME`, upper_thermal = `95th percentile`)][rls_summary, on= .(taxon), nomatch = NULL]
rls_summary_SGI <- sgi_dt[, .(taxon = `SPECIES_NAME`, SGI)][rls_summary, on= .(taxon), nomatch = NULL]

# Divide native vs non-native Australian species based on upper thermal limit
# Set thermal threshold to the av annual temperature of the warmest site
thresh <- rls_sites[, max(sst_t1)]

rls_summary_thermal[, type:= ifelse(upper_thermal < thresh, "aus", "indo")]

# or split at latitude -15
rls_summary_thermal[limit == "northern", type2:= ifelse(lat1 < -15, "aus", "indo")]

stat_box_data <- function(y, upper_limit = max(rls_summary$dLat) * 1.15) {
  return( 
    data.frame(
      y = 0.95 * upper_limit,
      label = paste('N =', length(y), '\n',
                    'mean =', round(mean(y), 1), '\n')
    )
  )
}

N_limit_dist_plot <- ggplot(rls_summary_thermal[guild == "tropical" & limit == "northern"], 
       aes(x = type, y = dLat)) +
    geom_boxplot() +
    geom_hline(yintercept = 0, lty = "dashed") +
    stat_summary(
        fun.data = stat_box_data, 
        geom = "text", 
        hjust = 0.5,
        vjust = 0.9
    ) + 
  facet_wrap(vars(ecoregion)) +
    labs(y = "dLat", title = "Latitudinal changes before and after 2016 heatwave") +
    theme_bw()

therm_table <- rls_summary_thermal[guild == "tropical" & limit == "northern", 
                          .(N = NROW(dLat),
                            dLat_mean = mean(dLat),
                            dLat_sd = sd(dLat),
                            dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                          by = .(type, ecoregion)]

therm_plot <- ggplot(therm_table,
                         aes(x = type, y = dLat_mean)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(y = "", title = "") +
  theme_bw()


N_limit_thermal <- ggplot(rls_summary_thermal[limit == "northern" & guild == "tropical"],
                              aes(x = upper_thermal, y = dLat, col = type)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(x = "Upper thermal limit (C)") +
  theme_bw()

ggplot(rls_summary_SGI[limit == "northern" & guild == "tropical"],
                              aes(x = SGI, y = dLat)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(labs = "Ppopulation trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

# Collate plots

library(ggpubr)

N_limit_plots <- ggarrange(N_limit_dist_plot, N_limit_thermal,
                               nrow = 1, ncol = 2,
                               widths = c(1.4, 1))

# Species distribution curves

dist_curves <- rls[, .(lat = unique(lat), lat_abun = unique(lat_abun)),
                  by = .(taxon, side, limit, period)]

ggplot() +
  
  geom_point(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "blue") +
  geom_smooth(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), col = "blue",
             method = "loess") +
  
  geom_point(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "red") +
  geom_smooth(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), col = "red",
             method = "loess") +
  
  coord_flip() +
  
  facet_wrap(taxon ~ side, scales = "free") +
  
  theme_bw()
```


EXTRA STUFF
```{r}
# To include a change in range
# Calculate change in latitudinal range
rls_summary_range <- rls_summary[limit == "northern", .(lat_N1 = lat, lat_N2 = lat + dLat), by = .(taxon, side, method)][rls_summary[limit == "southern", .(lat_S1 = lat, lat_S2 = lat + dLat), by = .(taxon, side, method)], on= .(taxon, side, method)][, .(range1 = lat_N1 - lat_S1, range2 = lat_N2 - lat_S2), by = .(taxon, side, method)]

rls_summary_range <- rls_summary_range[, .(dRange = range2 - range1), by = .(taxon, side, method)]

rls_summary <- rls_summary[rls_summary_range, on= .(taxon, side, method)]
```

***
