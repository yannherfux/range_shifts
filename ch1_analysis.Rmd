---
title: "Distinguishing latitudinal changes of shallow reef species over a decade of environmental change in Australia"
author: "Yann Herrera Fuchs"
date: "2023-01-25"
output: 
  html_document:
    theme: darkly
    highlight: default
    toc: true
    toc_depth: 3
    toc_float:
      toc_collapse: true
    code_folding: hide
    fig_width: 10
    fig_height: 7
    fig_caption: true
---

This is the code used for analyzing the data for Chapter 1

Remember to set working directory

# Load initial packages and data {.tabset}

*Packages used* 
```{r Load packages, message=FALSE, warning=FALSE}
rm(list = ls()) # clear environment memory

dir <- "C:/Users/yherrera/OneDrive - University of Tasmania/Desktop/UTas/R"
setwd(dir)

# Data wrangling
library(tidyverse) # for manipulating data in tidy format
library(data.table) # summarizing and subsetting more efficiently using data.table syntax
library(DT) # for online data.table manipulation

# Statistical analysis

# Maps and figures

```

*Input data*
```{r Reading raw data, message=FALSE}
# RLS dataset
rls.raw <- fread(paste0(dir, "/Raw Data/ep_m1_m2_AUS.csv")) #nrows = 1,634,614

# Species traits dataset (for extracting guild information)
traits <- fread(paste0(dir, "/Raw Data/TRAITS MASTER.csv")) #nrows = 5,188

# RLS survey ID sea-surface temperature dataset (Conor's method)
sst_data <- fread(paste0(dir, "/Raw Data/rls_sites_sst2.csv")) #nrows = 54,973
```

***
## Code
### Organizing data

Add trait information relevant to analysis.
```{r}
# Extract thermal guild info
traits <- traits[, .(taxon = `CURRENT_SPECIES_NAME`,
                     guild = `thermal guild`,
                     max_length = `MaxLength`,
                     mobility = `Water column`)]

# Join datasets
rls <- rls.raw[traits, on= "taxon", nomatch = NULL] # nrow = 1,575,691
```

Add information on SST at each survey. We are using the average of the 2-years daily SST leading to the survey date. This is to account for periods of extreme or anomalous weather events.
```{r}
# Get mean SST at each survey ID
sst_data <- sst_data[, .(mean_sst = mean(mean_sst, na.rm = TRUE)), by = .(survey_id)] # nrow = 28,074

# Select columns of interest from SST data
rls <- rls[sst_data[, .(survey_id, mean_sst)], on= .(survey_id), nomatch = NULL]#nrow = 1,575,691

rls <- rls[!is.na(mean_sst)] #nrow = 1,272,629
```

***

### Filtering and processing the data 
#### Removing unnecessary data

Remove data that will not be used in this analysis.
```{r Remove unnecessary data, message=FALSE, warning=FALSE}
# Remove species with .sp and .spp (those which don't have species fully resolved)
rls <- rls[which(grepl("sp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,271,507
rls <- rls[which(grepl("spp.", as.character(rls$taxon), fixed = T) == F), ] #nrow = 1,250,239

# Remove NAs in taxon data
rls <- rls[which(is.na(rls$taxon) == F), ] #nrow = 1,250,239

# Select vertebrate and invertebrate classes to include in analysis
rls <- rls[class %in% c("Asteroidea", "Cephalopoda", "Crinoidea", "Echinoidea", "Gastropoda", "Holothuroidea", "Malacostraca", "Actinopterygii", "Elasmobranchii"), ] #nrow = 1,243,447 
#NOTE: changed Chondrichtyes to Elasmobranchii, Crinoidea and Holothuroidea not found in raw dataset

# Subset to data from 2010 onwards
rls <- rls[year(survey_date) >= "2010"] #nrow = 1,105,909
```

#### Data adjustments
Make sure that there is a unique latitude and longitude value for each site_code.

```{r}
# Calculate mean latitude and longitude values to obtain unique coordinates
rls_sites <- rls[, lapply(.SD, mean), 
                 by = .(site_code),
                 .SDcols = c("latitude", "longitude")]


rls <- rls[, c(1:8, 11:36)][rls_sites, on= .(site_code)] 
```

Adjust method and block data. There should only be two blocks in each transect, and cryptic fish and invertebrates are only found in method 2.
```{r Adjust method and block, message=FALSE, warning=FALSE}
# Remove block 0
rls <- rls[block != 0] #nrow = 1,105,907

# Remove fish species in M2 from M1 (cryptic fish)
rls[method == 1 & taxon %in% rls[method == 2 & class == "Actinopterygii"]$taxon]$method <- 2
    
# Change method 1 inverts to method 2
rls[class != "Actinopterygii" & class != "Elasmobranchii"]$method <- 2
```

The raw data is already tallied by block, so we need to sum abundance data for each species by survey ID to get N per 500m^2^ for M1, and per 50m^2^ for M2 (the total of each unique species on each survey).
```{r Summing abundance data, message=FALSE, warning=FALSE}
rls <- rls[, .(total = sum(total)), 
           by = .(taxon, survey_id,
                  # add factors of interest
                  class, guild, 
                  max_length, mobility, 
                  site_code, latitude, longitude,
                  survey_date, 
                  mean_sst)] #nrow = 457,436
```

#### Site selection and time periods
In order to avoid sampling biases, we focus on analyzing latitudinal change from the first and last years that sites were surveyed using June 2016 as a heatwave cutoff 

```{r}
# Define period
rls <- rls[, period:= ifelse(survey_date < "2016-06-01", # heatwave period
                             "t1", "t2")]
# Select sites
rls <- rls[, ':=' (year_i = min(year(survey_date)),
                   year_f = max(year(survey_date)),
                   dt = max(year(survey_date)) - min(year(survey_date))),
           by = .(site_code)]

# Remove data in between those time periods and those sites that were only surveyed once. Also removed sites that were not found in both periods
rls <- rls[year(survey_date) == year_i | year(survey_date) == year_f] #nrow = 273.647
rls <- rls[dt > 0] #nrow = 205,254
rls <- rls[site_code %in% rls[period == "t1"]$site_code & site_code %in% rls[period == "t2"]$site_code] #nrow = 178,215
```

#### Further filtering

To reduce noise we set taxon-level filters.

```{r}
# Discard species occurring in less than 30 sites.
species_list <- rls[, .(site_code = unique(site_code)), by = .(taxon)][, .(N_site = .N), by = .(taxon)]
rls <- rls[species_list, on= .(taxon)][N_site >= 30] # nrow = 164,659

# Categorize rare and common species based on whether they appear in less than 80 sites in the first time period
rls <- rls[, presence:= ifelse(N_site < 80, "rare", "common"), 
                    by = .(taxon)]
```

We also have to calculate the average abundance of species per site per period, and average temperature data the same way.
```{r Site-specific temperature and abundance data per year, message=TRUE, warning=FALSE}
# Density (abundance per site), temperature and site calculations by year
rls <- rls[, lapply(.SD, mean), # calculate means for the specified data cols
           by = .(taxon, site_code, period,
                  # include factors of interest
                  class, 
                  guild, max_length, presence, mobility, 
                  latitude, longitude,
                  year_i, year_f, dt,
                  N_site), # subsets
           .SDcols = c("total", "mean_sst")] # data cols to average
# nrow = 101,105
```

### Calculating distribution limits

##### Skew values, 5th and 95th percentiles

To compare parameter values to changes in abundance, we calculate the midway point (skew), 5th and 95th percentiles of cumulative site abundance for each species at each period. Then we extract the latitude associated to these values to assess the change before and after the heatwave.

```{r}
# Order "rls" dataset from north to south for each species
rls <- rls[order(taxon, -latitude)]

rls[, cum_abun:= cumsum(total),
          by = .(taxon, period, guild)]

# Calculate midway point, 5th and 95th percentiles
rls[, ':=' (abun_mid = max(cum_abun) * 0.5,
                  abun_5 = max(cum_abun) * 0.05,
                  abun_95 = max(cum_abun) * 0.95), 
          by = .(taxon, period, guild)]

# Choose the latitude associated to the minimum difference between the midway point and the cumulative site abundance, for each taxon, period and side.
Latskew <- rls[, .(min_dif = abs(abun_mid - cum_abun), 
                              cum_abun, abun_mid, 
                               Latskew = latitude,
                               Lonskew = longitude,
                               siteskew = site_code,
                               Tempskew = mean_sst), 
                           by = .(taxon, period, guild)][order(taxon, period, guild, min_dif)][, .SD[1], by = .(taxon, period, guild)]

# Join to main rls subset
rls <- rls[Latskew[, .(taxon, period, guild, Latskew, Lonskew, siteskew, Tempskew)], on= .(taxon, period, guild)]

# Choose the latitude associated to the minimum difference between the 5th percentile and the cumulative site abundance, for each taxon and period.
Lat05 <- rls[, .(min_dif = abs(abun_5 - cum_abun), 
                             cum_abun, abun_5, 
                             Lat05 = latitude,
                             Lon05 = longitude,
                             site05 = site_code,
                             Temp05 = mean_sst), 
                        by = .(taxon, period, guild)][order(taxon, period, guild, min_dif)][, .SD[1], by = .(taxon, period, guild)]

# Join to main rls subset
rls <- rls[Lat05[, .(taxon, period, guild, Lat05, Lon05, site05, Temp05)], on= .(taxon, period, guild)]

# Choose the latitude associated to the minimum difference between the 95th percentile and the cumulative site abundance, for each taxon and period.
Lat95 <- rls[, .(min_dif = abs(abun_95 - cum_abun), 
                             cum_abun, abun_95, 
                             Lat95 = latitude,
                             Lon95 = longitude,
                             site95 = site_code,
                             Temp95 = mean_sst), 
                         by = .(taxon, period, guild)][order(taxon, period, guild, min_dif)][, .SD[1], by = .(taxon, period, guild)]

# Join to main rls subset
rls <- rls[Lat95[, .(taxon, period, guild, Lat95, Lon95, site95, Temp95)], on= .(taxon, period, guild)]
```

### Analysis

#### Restructure dataset
```{r}
## Order by limit and category
# Abundance weighted quantiles
rls_N <- rls[, 
             .(taxon, class, guild, max_length, presence, mobility,
               site_code, latitude, longitude, N_site,
               period, year_i, year_f, dt,
               total, mean_sst, 
               lat = Lat05,
               lat_abun = abun_5,
               lon = Lon05,
               site = site05,
               temp = Temp05,
               limit = "northern")]

rls_S <- rls[, 
             .(taxon, class, guild, max_length, presence, mobility,
               site_code, latitude, longitude, N_site,
               period, year_i, year_f, dt,
               total, mean_sst, 
               lat = Lat95,
               lat_abun = abun_95,
               lon = Lon95,
               site = site95,
               temp = Temp95,
               limit = "southern")]

rls <- rbind(rls_N, rls_S) #nrow = 202,210; 977 sites, 699 species 

## Remove unnecessary datasets
rm(Lat05, Latskew, Lat95,
   rls.raw, 
   species_list,
   rls_N, rls_S)
```


#### Calculate changes in periods
```{r}
### Calculate latitudinal changes for each species' limits, dispersion index and population trends
rls_summary_t1 <- rls[period == "t1", 
                      .(lat1 = unique(lat), lon1 = unique(lon), site1 = unique(site), 
                        temp1 = unique(temp), 
                        total_log1 = log(unique(lat_abun) + 1)),
                      by = .(taxon, limit,
                             # include factors of interest
                             class, guild, max_length, presence, mobility, N_site)] # nrow = 1,394


rls_summary_t2 <- rls[period == "t2", 
                      .(lat2 = unique(lat), lon2 = unique(lon), site2 = unique(site), 
                        temp2 = unique(temp), 
                        total_log2 = log(unique(lat_abun) + 1)),
                      by = .(taxon, limit,
                             #include factors of interest
                             class, guild, max_length, presence, mobility, 
                             N_site)] # nrow = 1,394

rls_summary <- rls_summary_t1[rls_summary_t2, on = .(taxon, class, guild, max_length, presence, mobility, limit)] #nrow = 1,394

rls_summary <- rls_summary[, ':=' (dLat = lat2 - lat1,
                                   dLon = lon2 - lon1,
                                   dTemp = temp2 - temp1,
                                   pop_trend = total_log2 - total_log1)]

rls_summary <- rls_summary[!is.na(dLat)] #nrow = 1,390

# Organize dataset
rls_summary <- rls_summary[, .(taxon, class, 
                               guild, limit, 
                               lat1, lat2, dLat,
                               lon1, lon2, dLon,
                               site1, site2, N_site,
                               temp1, temp2, dTemp,
                               total_log1, total_log2, pop_trend,
                               max_length, presence, mobility)]

# Remove species that are errors
errors <- c("Eocallionymus papilio", "Chelmonops truncatus", "Pteraeolidia ianthina", "Istigobius rigilius", "Cheilodipterus quinquelineatus", "Orectolobus halei", "Oxycomanthus bennetti", "Comanthus tasmaniae", "Dotalabrus aurantiacus")

rls_summary <- rls_summary[!which(taxon %in% errors)] #nrow = 1,372

# Save dataset for corrections and checking of species limits
write.csv(rls_summary, paste0(dir, "/chapter1/rls_summary.csv"), row.names = FALSE)
```

#### Statistical analysis
```{r}
# Statistical significance
#t.test(rls_summary[abs(dLat) < 5 & guild == "tropical" & limit == #"northern"]$dLat, mu = 0) # p < 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "southern" & guild == #"tropical" & side == "west"]$dLat, mu = 0) # p < 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "northern" & guild == #"temperate" & side == "west"]$dLat, mu = 0) # p = 0.05
#t.test(rls_summary[abs(dLat) < 5 & limit == "northern" & guild == #"temperate" & side == "east"]$dLat, mu = 0) # p < 0.05

#rls_summary[abs(dLat) < 5 & limit != "optimum", t.test(dLat, mu = 0), by = .(guild, side, limit)][p.value < 0.05]



#fit <- aov(dLat ~ 1 + guild + limit + side, data = rls_summary)

#library(multcomp)

#summary(glht(fit, linfct = mcp(guild = "Dunnett")))
```


#### Plots
```{r}
# Create factors
rls_summary <- rls_summary[, ':=' (guild = factor(guild, levels = c("tropical", "temperate")),
                                   class = factor(ifelse(class == "Actinopterygii", "fish", "invertebrate"), levels = c("fish", "invertebrate")),
                                   presence = factor(presence, levels = c("common", "rare")),
                                   mobility = factor(mobility),
                                   limit = factor(limit, levels = c("northern", "optimum", "southern")))]
```

##### Summary Plots
```{r}
## Main data distribution
rls_summary_bp <- ggplot(rls_summary, 
                         aes(x = guild, y = dLat, col = guild)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Latitudinal changes in species limits") +
  theme_bw()

# Averages
rls_means_wt <- rls_summary[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                              dTemp_mean = mean(dTemp),
                              dTemp_sd = sd(dTemp),
                              dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                            by = .(limit, guild)]

rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = guild, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Average latitudinal displacement of species limits") +
  theme_bw()

library(ggpubr)

ggarrange(rls_summary_bp, rls_means_plot_wt,
          nrow = 2, ncol = 1)

# Circle of Australia
rls_summary <- rls_summary[, region:= ifelse(lat1 > -27 & lon1 < 147, "NW",
                                             ifelse(lat1 < -27 & lon1 < 115, "Sw",
                                                    ifelse(lat1 %between% c(-40, 30) & lon1 %between% c(115, 147), "S",
                                                           ifelse(lat1 %between% c(-40, -27) & lon1 > 147, "SE", 
                                                                  ifelse(lat1 > -27 & lon1 > 147, "NE", "TAS"))))),
                           by = .(taxon, limit)]

rls_means_region <- rls_summary[, 
                                .(N = NROW(dLat),
                                  dLat_mean = mean(dLat),
                                  dLat_sd = sd(dLat),
                                  dLat_se = sd(dLat) / sqrt(NROW(dLat)),
                                  dTemp_mean = mean(dTemp),
                                  dTemp_sd = sd(dTemp),
                                  dTemp_se = sd(dTemp) / sqrt(NROW(dTemp))),
                                by = .(limit, guild, region)]

rls_means_region_plot <- ggplot(rls_means_region,
                                aes(x = region, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Average latitudinal displacement of species limits") +
  theme_bw()

```

##### Species wallpaper
```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Species wallpapers
taxon_list <- rls_summary[limit != "optimum"][order(-abs(dLat))][, .SD[1:50]]$taxon

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

ggplot() +
  # Rasters
  geom_sf(data = aus_sf) +
  
  # sites included in analysis
  geom_point(data = rls[limit != "optimum"][taxon %in% taxon_list], 
             aes(x = longitude, y = latitude, shape = side),
             size = 3) +
  
  # Select shapes to display
  scale_shape_manual(values = c("east" = 1, "west" = 2)) +
  
  # Limit lines
  geom_hline(data = rls[limit != "optimum"][taxon %in% taxon_list],
             aes(yintercept = lat, col = limit, lty = side)) +
  
  # East/west division
  geom_vline(xintercept = 142.5, lty = "dashed") +
  annotate("text", x = 150, y = -7, label = "east") +
  annotate("text", x = 132, y = -7, label = "west") +
  
  # Facet by taxon
  facet_wrap(vars(taxon, period)) +
  
  ylim(-44, -7) +
  xlim(110, 160) +
  theme_bw()
```


##### Site distribution and temperature map

```{r}
library(sf) # processing spatial vector data
library(raster) # manipulating rasters
library(terra) # spatial data analysis
library(gstat) # producing inverse distance weighted means

# Calculate dSST at each site using the heatwave periods
rls_sites <- rls[period == "t1",
                 .(sst_t1 = mean(mean_sst)),
                 by = .(site_code, latitude, longitude)][rls[period == "t2",
                                                             .(sst_t2 = mean(mean_sst)),
                                                             by = .(site_code)], on = .(site_code), nomatch = NULL]

rls_sites <- rls_sites[, .(latitude,
                           longitude,
                           sst_t1, sst_t2,
                           dSST = sst_t2 - sst_t1), 
                       by = .(site_code)] # nrow = 977

# Add dSST data
rls_summary <- rls_summary[rls_sites[, .(latitude, longitude, dSST), by = .(site1 = site_code)], on= .(site1),
                           nomatch = NULL] #nrow = 1,372

# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_sites_sf <- st_as_sf(rls_summary, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
  cellsize = c(1, 1), # 1 degree cell size
  what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dSST ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_sites_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dSST")

# Plot
site_dSST_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dSST)) +
  geom_sf(data = aus_sf) +
  
  # sites included in analysis
  geom_point(data = rls_summary, 
             aes(x = longitude, y = latitude),
             shape = 1, col = "black", size = 3) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-0.38, 2.5, 2.87),
                       limits = c(-0.38, 2.5)) +
  
  ylim(-44, -7) +
  xlim(110, 160) +
  labs(fill = "dSST", title = "Site distribution and temperature change") +
  theme_bw()


## dLat maps

# Northern
# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_dLat <- rls_summary[limit == "northern", .(longitude, latitude, dLat)]
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
  cellsize = c(1, 1), # 1 degree cell size
  what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatN_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = aus_sf) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-6.1, 5.3, 2.28),
                       limits = c(-6.1, 5.3)) +
  
  ylim(-44, -7) +
  xlim(110, 160) +
  labs(fill = "dLat", title = "Average latitudinal changes: northern limits") +
  theme_bw()

# Southern
# Create simple features objects and a spatial grid for interpolation
aus_pols <- raster::getData("GADM", country = "Australia", level = 1)
crs(aus_pols) <- "EPSG:4979" # have to specify CRS with WKT comment now
aus_sf <- st_transform(st_as_sf(aus_pols), crs = crs(aus_pols))

rls_dLat <- rls_summary[limit == "southern", .(longitude, latitude, dLat)]
rls_dLat_sf <- st_as_sf(rls_dLat, coords = c("longitude", "latitude"), crs = crs(aus_pols))

grd <- st_bbox(c(xmin = 110, xmax = 160, ymin = -44, ymax = -7), crs = crs(aus_pols)) %>% 
  st_as_sfc() %>% 
  st_make_grid(
  cellsize = c(1, 1), # 1 degree cell size
  what = "centers"
  ) %>%
  st_as_sf() %>%
  cbind(., st_coordinates(.)) %>% 
  st_drop_geometry() %>% 
  mutate(Z = 0) %>%
  raster::rasterFromXYZ( # Convert to raster object
    crs = crs(aus_pols)
  )

# Fit an inverse distance weighted mean model
fit_IDW <- gstat::gstat(
  formula = dLat ~ 1,
  maxdist = 220, vdist = T, #radius of 2 degrees
  data = as(rls_dLat_sf, "Spatial")
)

# Make sure data and new data have same CRS
crs(grd) <- "+proj=longlat +datum=WGS84 +no_defs"

# Interpolate
interp_IDW <- interpolate(grd, fit_IDW) 

# Convert raster to points
pnts <- rasterToPoints(interp_IDW) %>% as_tibble()
colnames(pnts) <- c("lon", "lat", "dLat")

# Plot
dLatS_plot <- ggplot() +
  # Rasters
  geom_raster(data= pnts, aes(lon, lat, fill = dLat)) +
  geom_sf(data = aus_sf) +
  
  # manual color scale
  scale_fill_gradient2(low = "blue", mid = "grey", high = "red",
                       midpoint = 0,
                       breaks = seq(-6, 4, 1.6),
                       limits = c(-6, 4)) +
  
  ylim(-44, -7) +
  xlim(110, 160) +
  labs(fill = "dLat", title = "Average latitudinal changes: southern limits") +
  theme_bw()

# Combine maps
dLat_plot <- ggarrange(dLatN_plot, dLatS_plot,
                       nrow = 2, ncol = 1)
ggarrange(site_dSST_plot, dLat_plot,
          nrow = 1, ncol = 2)
```


##### Comparing extreme values
```{r}
rls_ext <- fread(paste0(dir, "/chapter1/rls_summary_ext.csv")) #nrows = 1,634,614

rls_summary[, type:= "normal"]
rls_ext[, type:= "extreme"]

rls_ext <- rls_ext[taxon %in% rls_summary$taxon]

rls_summary_both <- rls_summary[, !c(13, 21)][rls_ext[, .(dLat_ext = dLat), by = .(taxon, limit)], on = .(taxon, limit)][, dLat_dif:= dLat_ext - dLat, by = .(taxon, limit)]

rls_summary_comb <- rbind(rls_summary[, !c(13, 21)], rls_ext)
rls_summary_comb <- rls_summary_comb[taxon %in% rls_summary_both[abs(dLat_dif) > 3]$taxon]


rls_summary_comb <- rls_summary_comb[order(-type, limit, -dLat)]
rls_summary_comb$taxon <- factor(rls_summary_comb$taxon, levels = unique(rls_summary_comb$taxon))

ggplot(rls_summary_comb, aes(x = taxon, y = dLat, col = type, shape = guild)) +
  geom_point() +
  facet_grid(limit ~.)

# Averages
rls_means_wt <- rls_summary_comb[, 
                            .(N = NROW(dLat),
                              dLat_mean = mean(dLat),
                              dLat_sd = sd(dLat),
                              dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                            by = .(limit, guild, type)]

rls_means_plot_wt <- ggplot(rls_means_wt,
                            aes(x = type, y = dLat_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~.) +
  labs(y = "dLat", title = "Average latitudinal displacement of species limits") +
  theme_bw()

```


##### Regression plots
```{r}
# dLat vs dSST regression
dLat_dSST_plot <- ggplot(rls_summary[limit != "optimum"],
                         aes(x = dSST, y = dLat, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(guild + limit ~ side, scales = "free") +
  labs(title = "") +
  theme_bw()

lm(
  dLat ~ 1 + dSST, data = rls_sites[, .(dSST), by = .(site = site_code)][rls_summary, on = .(site)][!is.na(dSST)][guild == "tropical"] 
)


# Exploratory correlations

## Abundance plots
ggplot(rls_summary[limit != "optimum"], 
       aes(x = class, y = pop_trend, col = guild)) +
  geom_boxplot() +
  facet_grid(limit ~ side)

abun_table <- rls_summary[limit != "optimum", 
                          .(N = NROW(pop_trend),
                            pop_trend_mean = mean(pop_trend),
                            pop_trend_sd = sd(pop_trend),
                            pop_trend_se = sd(pop_trend) / sqrt(NROW(pop_trend))),
                          by = .(class, side, limit, guild)]

abun_plot <- ggplot(abun_table,
                         aes(x = class, y = pop_trend_mean, col = guild)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = pop_trend_mean - pop_trend_se,
                    ymax = pop_trend_mean + pop_trend_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(limit ~ side) +
  labs(y = "Population trend", title = "Population trend following the 2016 heatwave") +
  theme_bw()


pop_trend_dSST_plot <- ggplot(rls_summary[limit != "optimum"],
                              aes(x = dSST, y = pop_trend, col = guild)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_grid(guild + class ~ side) +
  labs(labs = "Population trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

lm(
  pop_trend ~ 1 + dSST, data = rls_sites[, .(dSST), by = .(site = site_code)][rls_summary, on = .(site)][!is.na(dSST)][abs(pop_trend) != Inf][guild == "tropical"] 
)

## Thermal niche and SGIs

# Read thermal niche and SGI data
thermal_niche <- fread(paste0(dir, "/Raw Data/Thermal niche.csv")) #nrows = 4,465
sgi_dt <- fread(paste0(dir, "/Raw Data/SGIs.csv")) #nrows = 26,904

rls_summary_thermal <- thermal_niche[, .(taxon = `SPECIES_NAME`, upper_thermal = `95th percentile`)][rls_summary, on= .(taxon), nomatch = NULL]
rls_summary_SGI <- sgi_dt[, .(taxon = `SPECIES_NAME`, SGI)][rls_summary, on= .(taxon), nomatch = NULL]

# Divide native vs non-native Australian species based on upper thermal limit
# Set thermal threshold to the av annual temperature of the warmest site
thresh <- rls_sites[, max(sst_t1)]

rls_summary_thermal[, type:= ifelse(upper_thermal < thresh, "aus", "indo")]

# or split at latitude -15
rls_summary_thermal[limit == "northern", type2:= ifelse(lat1 < -15, "aus", "indo")]

stat_box_data <- function(y, upper_limit = max(rls_summary$dLat) * 1.15) {
  return( 
    data.frame(
      y = 0.95 * upper_limit,
      label = paste('N =', length(y), '\n',
                    'mean =', round(mean(y), 1), '\n')
    )
  )
}

N_limit_dist_plot <- ggplot(rls_summary_thermal[guild == "tropical" & limit == "northern"], 
       aes(x = type, y = dLat)) +
    geom_boxplot() +
    geom_hline(yintercept = 0, lty = "dashed") +
    stat_summary(
        fun.data = stat_box_data, 
        geom = "text", 
        hjust = 0.5,
        vjust = 0.9
    ) + 
  facet_wrap(vars(ecoregion)) +
    labs(y = "dLat", title = "Latitudinal changes before and after 2016 heatwave") +
    theme_bw()

therm_table <- rls_summary_thermal[guild == "tropical" & limit == "northern", 
                          .(N = NROW(dLat),
                            dLat_mean = mean(dLat),
                            dLat_sd = sd(dLat),
                            dLat_se = sd(dLat) / sqrt(NROW(dLat))),
                          by = .(type, ecoregion)]

therm_plot <- ggplot(therm_table,
                         aes(x = type, y = dLat_mean)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = dLat_mean - dLat_se,
                    ymax = dLat_mean + dLat_se),
                width = 0.2, position = position_dodge(width = 0.3)) +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(y = "", title = "") +
  theme_bw()


N_limit_thermal <- ggplot(rls_summary_thermal[limit == "northern" & guild == "tropical"],
                              aes(x = upper_thermal, y = dLat, col = type)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(x = "Upper thermal limit (C)") +
  theme_bw()

ggplot(rls_summary_SGI[limit == "northern" & guild == "tropical"],
                              aes(x = SGI, y = dLat)) +
  geom_point() +
  geom_smooth(method = 'glm', color = "black") +
  geom_hline(yintercept = 0, lty = "dashed") +
  facet_wrap(vars(ecoregion)) +
  labs(labs = "Ppopulation trend", title = "Population trend in relation to site-level temperature 
       change for temperate and tropical species") +
  theme_bw()

# Collate plots

library(ggpubr)

N_limit_plots <- ggarrange(N_limit_dist_plot, N_limit_thermal,
                               nrow = 1, ncol = 2,
                               widths = c(1.4, 1))

# Species distribution curves

dist_curves <- rls[, .(lat = unique(lat), lat_abun = unique(lat_abun)),
                  by = .(taxon, side, limit, period)]

ggplot() +
  
  geom_point(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "blue") +
  geom_smooth(data = dist_curves[period == "preheatwave"], 
             aes(x = lat, y = lat_abun), col = "blue",
             method = "loess") +
  
  geom_point(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), 
             alpha = 0.3, size = 3, col = "red") +
  geom_smooth(data = dist_curves[period == "postheatwave"], 
             aes(x = lat, y = lat_abun), col = "red",
             method = "loess") +
  
  coord_flip() +
  
  facet_wrap(taxon ~ side, scales = "free") +
  
  theme_bw()
```


EXTRA STUFF
```{r}
# To include a change in range
# Calculate change in latitudinal range
rls_summary_range <- rls_summary[limit == "northern", .(lat_N1 = lat, lat_N2 = lat + dLat), by = .(taxon, side, method)][rls_summary[limit == "southern", .(lat_S1 = lat, lat_S2 = lat + dLat), by = .(taxon, side, method)], on= .(taxon, side, method)][, .(range1 = lat_N1 - lat_S1, range2 = lat_N2 - lat_S2), by = .(taxon, side, method)]

rls_summary_range <- rls_summary_range[, .(dRange = range2 - range1), by = .(taxon, side, method)]

rls_summary <- rls_summary[rls_summary_range, on= .(taxon, side, method)]
```

***
